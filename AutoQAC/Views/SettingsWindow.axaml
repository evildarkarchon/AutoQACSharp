<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AutoQAC.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        d:DesignWidth="550" d:DesignHeight="650"
        x:Class="AutoQAC.Views.SettingsWindow"
        x:DataType="vm:SettingsViewModel"
        Title="Settings"
        Width="550" Height="650"
        MinWidth="500" MinHeight="550"
        CanResize="False"
        WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <!-- Validation border styles for path TextBoxes -->
        <SolidColorBrush x:Key="PathValidBrush" Color="#4CAF50" />
        <SolidColorBrush x:Key="PathInvalidBrush" Color="#F44336" />
    </Window.Resources>

    <Grid Margin="20" RowDefinitions="*,Auto">

        <!-- Settings Content -->
        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="16">

                <!-- File Paths Section -->
                <StackPanel Spacing="8">
                    <TextBlock Text="File Paths"
                               FontSize="14" FontWeight="SemiBold" />

                    <!-- xEdit Path -->
                    <StackPanel Spacing="2">
                        <TextBlock Text="xEdit Executable:" FontSize="12" />
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding XEditPath}"
                                     Watermark="Path to SSEEdit.exe, FO4Edit.exe, etc."
                                     Margin="0,0,5,0" />
                            <!-- Validation indicator -->
                            <Panel Grid.Column="1" Width="24" VerticalAlignment="Center" Margin="0,0,5,0">
                                <TextBlock Text="&#x2713;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#4CAF50"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsXEditPathValid, Converter={StaticResource IsTrueConverter}}" />
                                <TextBlock Text="&#x2717;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#F44336"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsXEditPathValid, Converter={StaticResource IsFalseConverter}}" />
                            </Panel>
                            <Button Grid.Column="2"
                                    Content="Browse..."
                                    Command="{Binding BrowseXEditCommand}"
                                    MinWidth="80" />
                        </Grid>
                    </StackPanel>

                    <!-- MO2 Path -->
                    <StackPanel Spacing="2">
                        <TextBlock Text="Mod Organizer 2 (optional):" FontSize="12" />
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding Mo2Path}"
                                     Watermark="Path to ModOrganizer.exe (optional)"
                                     Margin="0,0,5,0" />
                            <Panel Grid.Column="1" Width="24" VerticalAlignment="Center" Margin="0,0,5,0">
                                <TextBlock Text="&#x2713;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#4CAF50"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsMo2PathValid, Converter={StaticResource IsTrueConverter}}" />
                                <TextBlock Text="&#x2717;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#F44336"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsMo2PathValid, Converter={StaticResource IsFalseConverter}}" />
                            </Panel>
                            <Button Grid.Column="2"
                                    Content="Browse..."
                                    Command="{Binding BrowseMo2Command}"
                                    MinWidth="80" />
                        </Grid>
                    </StackPanel>

                    <!-- Load Order Path -->
                    <StackPanel Spacing="2">
                        <TextBlock Text="Load Order File (optional):" FontSize="12" />
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding LoadOrderPath}"
                                     Watermark="Path to loadorder.txt (optional)"
                                     Margin="0,0,5,0" />
                            <Panel Grid.Column="1" Width="24" VerticalAlignment="Center" Margin="0,0,5,0">
                                <TextBlock Text="&#x2713;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#4CAF50"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsLoadOrderPathValid, Converter={StaticResource IsTrueConverter}}" />
                                <TextBlock Text="&#x2717;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#F44336"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsLoadOrderPathValid, Converter={StaticResource IsFalseConverter}}" />
                            </Panel>
                            <Button Grid.Column="2"
                                    Content="Browse..."
                                    Command="{Binding BrowseLoadOrderCommand}"
                                    MinWidth="80" />
                        </Grid>
                    </StackPanel>

                    <!-- Data Folder Path -->
                    <StackPanel Spacing="2">
                        <TextBlock Text="Data Folder (optional):" FontSize="12" />
                        <Grid ColumnDefinitions="*,Auto,Auto">
                            <TextBox Grid.Column="0"
                                     Text="{Binding DataFolderPath}"
                                     Watermark="Path to game Data folder (optional)"
                                     Margin="0,0,5,0" />
                            <Panel Grid.Column="1" Width="24" VerticalAlignment="Center" Margin="0,0,5,0">
                                <TextBlock Text="&#x2713;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#4CAF50"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsDataFolderPathValid, Converter={StaticResource IsTrueConverter}}" />
                                <TextBlock Text="&#x2717;"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="#F44336"
                                           HorizontalAlignment="Center"
                                           IsVisible="{Binding IsDataFolderPathValid, Converter={StaticResource IsFalseConverter}}" />
                            </Panel>
                            <Button Grid.Column="2"
                                    Content="Browse..."
                                    Command="{Binding BrowseDataFolderCommand}"
                                    MinWidth="80" />
                        </Grid>
                    </StackPanel>
                </StackPanel>

                <Separator />

                <!-- Log Retention Section -->
                <StackPanel Spacing="10">
                    <TextBlock Text="Log Retention"
                               FontSize="14" FontWeight="SemiBold" />

                    <Grid ColumnDefinitions="180,*">
                        <TextBlock Grid.Column="0"
                                   Text="Retention Mode:"
                                   VerticalAlignment="Center" />
                        <ComboBox Grid.Column="1"
                                  SelectedIndex="{Binding RetentionMode}"
                                  HorizontalAlignment="Stretch">
                            <ComboBoxItem Content="Age-based (delete after N days)" />
                            <ComboBoxItem Content="Count-based (keep last N files)" />
                        </ComboBox>
                    </Grid>

                    <!-- Age-based: MaxAgeDays (visible when RetentionMode == 0) -->
                    <Grid ColumnDefinitions="180,*"
                          IsVisible="{Binding IsAgeBasedMode}">
                        <TextBlock Grid.Column="0"
                                   Text="Max Age (days):"
                                   VerticalAlignment="Center" />
                        <NumericUpDown Grid.Column="1"
                                       Value="{Binding MaxAgeDays}"
                                       Minimum="1"
                                       Maximum="365"
                                       Increment="1"
                                       FormatString="N0" />
                    </Grid>

                    <!-- Count-based: MaxFileCount (visible when RetentionMode == 1) -->
                    <Grid ColumnDefinitions="180,*"
                          IsVisible="{Binding IsCountBasedMode}">
                        <TextBlock Grid.Column="0"
                                   Text="Max Files to Keep:"
                                   VerticalAlignment="Center" />
                        <NumericUpDown Grid.Column="1"
                                       Value="{Binding MaxFileCount}"
                                       Minimum="1"
                                       Maximum="1000"
                                       Increment="5"
                                       FormatString="N0" />
                    </Grid>
                </StackPanel>

                <Separator />

                <!-- Cleaning Settings Section -->
                <StackPanel Spacing="10">
                    <TextBlock Text="Cleaning Settings"
                               FontSize="14" FontWeight="SemiBold" />

                    <!-- Cleaning Timeout -->
                    <Grid ColumnDefinitions="180,*">
                        <TextBlock Grid.Column="0"
                                   Text="Cleaning Timeout (seconds):"
                                   VerticalAlignment="Center" />
                        <StackPanel Grid.Column="1">
                            <NumericUpDown Value="{Binding CleaningTimeout}"
                                           Minimum="30"
                                           Maximum="3600"
                                           Increment="30"
                                           FormatString="N0" />
                            <TextBlock Text="{Binding CleaningTimeoutError}"
                                       Foreground="Red"
                                       FontSize="11"
                                       IsVisible="{Binding CleaningTimeoutError,
                                                   Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                        </StackPanel>
                    </Grid>

                    <!-- CPU Threshold -->
                    <Grid ColumnDefinitions="180,*">
                        <TextBlock Grid.Column="0"
                                   Text="CPU Threshold (%):"
                                   VerticalAlignment="Center" />
                        <NumericUpDown Grid.Column="1"
                                       Value="{Binding CpuThreshold}"
                                       Minimum="1"
                                       Maximum="100"
                                       Increment="5"
                                       FormatString="N0" />
                    </Grid>

                </StackPanel>

                <Separator />

                <!-- Plugin Backup Section -->
                <StackPanel Spacing="10">
                    <TextBlock Text="Plugin Backup"
                               FontSize="14" FontWeight="SemiBold" />

                    <CheckBox Content="Enable plugin backup before cleaning"
                              IsChecked="{Binding BackupEnabled}" />

                    <TextBlock Text="Plugins are backed up to a folder next to the game's Data directory"
                               FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               TextWrapping="Wrap"
                               Margin="28,0,0,0"
                               IsVisible="{Binding BackupEnabled}" />

                    <Grid ColumnDefinitions="180,*"
                          IsVisible="{Binding BackupEnabled}">
                        <TextBlock Grid.Column="0"
                                   Text="Sessions to Keep:"
                                   VerticalAlignment="Center" />
                        <StackPanel Grid.Column="1">
                            <NumericUpDown Value="{Binding BackupMaxSessions}"
                                           Minimum="1"
                                           Maximum="100"
                                           Increment="1"
                                           FormatString="N0" />
                            <TextBlock Text="{Binding BackupMaxSessionsError}"
                                       Foreground="Red"
                                       FontSize="11"
                                       IsVisible="{Binding BackupMaxSessionsError,
                                                   Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                        </StackPanel>
                    </Grid>

                    <TextBlock Text="Backup is unavailable in MO2 mode"
                               FontSize="11"
                               Foreground="#E6A817"
                               FontStyle="Italic"
                               Margin="28,0,0,0"
                               IsVisible="{Binding Mo2Mode}" />
                </StackPanel>

                <Separator />

                <!-- Mode Settings Section -->
                <StackPanel Spacing="10">
                    <TextBlock Text="Mode Settings"
                               FontSize="14" FontWeight="SemiBold" />

                    <CheckBox Content="MO2 Mode (Use Mod Organizer 2 for launching xEdit)"
                              IsChecked="{Binding Mo2Mode}" />
                </StackPanel>

            </StackPanel>
        </ScrollViewer>

        <!-- Button Panel -->
        <Grid Grid.Row="1"
              ColumnDefinitions="Auto,*,Auto,Auto"
              Margin="0,20,0,0">

            <!-- Reset button on the left -->
            <Button Grid.Column="0"
                    Content="Reset to Defaults"
                    Command="{Binding ResetToDefaultsCommand}"
                    MinWidth="120" />

            <!-- Unsaved changes indicator -->
            <TextBlock Grid.Column="1"
                       Text="* Unsaved changes"
                       VerticalAlignment="Center"
                       Margin="15,0,0,0"
                       FontStyle="Italic"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       IsVisible="{Binding HasUnsavedChanges}" />

            <!-- Save and Cancel on the right -->
            <Button Grid.Column="2"
                    Content="Save"
                    Command="{Binding SaveCommand}"
                    IsDefault="True"
                    MinWidth="80"
                    Margin="0,0,10,0" />

            <Button Grid.Column="3"
                    Content="Cancel"
                    Command="{Binding CancelCommand}"
                    IsCancel="True"
                    MinWidth="80" />
        </Grid>
    </Grid>
</Window>
