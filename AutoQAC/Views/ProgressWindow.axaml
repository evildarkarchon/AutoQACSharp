<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AutoQAC.ViewModels"
        xmlns:models="using:AutoQAC.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="450"
        x:Class="AutoQAC.Views.ProgressWindow"
        x:DataType="vm:ProgressViewModel"
        Title="Cleaning Progress"
        Width="600" Height="450"
        CanResize="False"
        WindowStartupLocation="CenterOwner">

    <!-- ==================== ACTIVE CLEANING PANEL ==================== -->
    <Panel>
        <Grid Margin="20" RowDefinitions="Auto,Auto,Auto,Auto,*,Auto"
              IsVisible="{Binding !IsShowingResults}">

            <!-- Row 0: Current Plugin + Counter Badges -->
            <StackPanel Grid.Row="0" Spacing="6">
                <TextBlock Text="Currently cleaning:"
                           FontWeight="SemiBold" FontSize="12"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                <TextBlock Text="{Binding CurrentPlugin}"
                           FontSize="16" FontWeight="Bold"
                           TextTrimming="CharacterEllipsis" />

                <!-- Counter Badges (hidden in preview mode) -->
                <StackPanel Orientation="Horizontal" Spacing="8"
                            IsVisible="{Binding HasCurrentPluginStats}"
                            Margin="0,2,0,0">
                    <!-- ITM Badge -->
                    <Border Background="#2D7D46" CornerRadius="3"
                            Padding="8,3">
                        <TextBlock FontWeight="SemiBold" FontSize="12"
                                   Foreground="White">
                            <Run Text="ITM: "/><Run Text="{Binding CurrentItmCount}"/>
                        </TextBlock>
                    </Border>

                    <!-- UDR Badge -->
                    <Border Background="#B8860B" CornerRadius="3"
                            Padding="8,3">
                        <TextBlock FontWeight="SemiBold" FontSize="12"
                                   Foreground="White">
                            <Run Text="UDR: "/><Run Text="{Binding CurrentUdrCount}"/>
                        </TextBlock>
                    </Border>

                    <!-- Nav Badge -->
                    <Border Background="#8B4513" CornerRadius="3"
                            Padding="8,3">
                        <TextBlock FontWeight="SemiBold" FontSize="12"
                                   Foreground="White">
                            <Run Text="Nav: "/><Run Text="{Binding CurrentNavCount}"/>
                        </TextBlock>
                    </Border>
                </StackPanel>
            </StackPanel>

            <!-- Row 1: Summary Bar -->
            <Border Grid.Row="1"
                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                    CornerRadius="4" Padding="10,6"
                    Margin="0,10,0,0">
                <TextBlock FontSize="13">
                    <Run Text="{Binding Progress}"/><Run Text="/"/><Run Text="{Binding Total}"/>
                    <Run Text=" plugins"/>
                    <Run Text=" -- "/>
                    <Run Text="{Binding SkippedCount}"/><Run Text=" skipped, "/>
                    <Run Text="{Binding FailedCount}"/><Run Text=" failed"/>
                </TextBlock>
            </Border>

            <!-- Row 2: Hang Detection Warning Banner -->
            <Border Grid.Row="2"
                    IsVisible="{Binding IsHangWarningVisible}"
                    Background="#FFF3E0"
                    BorderBrush="#E65100"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="10,8"
                    Margin="0,8,0,0">
                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                    <TextBlock Grid.Column="0"
                               Text="&#x26A0;"
                               FontSize="16"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0" />
                    <TextBlock Grid.Column="1"
                               Text="xEdit appears to be unresponsive"
                               TextWrapping="Wrap"
                               VerticalAlignment="Center"
                               Foreground="#BF360C" />
                    <Button Grid.Column="2"
                            Content="Wait"
                            Command="{Binding DismissHangWarningCommand}"
                            Padding="8,3"
                            Margin="5,0"
                            VerticalAlignment="Center" />
                    <Button Grid.Column="3"
                            Content="Kill"
                            Command="{Binding KillHungProcessCommand}"
                            Padding="8,3"
                            VerticalAlignment="Center"
                            Classes="accent" />
                </Grid>
            </Border>

            <!-- Row 3: Progress Bar -->
            <StackPanel Grid.Row="3" Spacing="4" Margin="0,10,0,0">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0" Text="Progress:" FontWeight="SemiBold" />
                    <TextBlock Grid.Column="1" Text="{Binding ProgressText}" />
                </Grid>
                <ProgressBar Value="{Binding Progress}"
                             Maximum="{Binding Total}"
                             Height="25" />
            </StackPanel>

            <!-- Row 4: Completed Plugins List -->
            <Grid Grid.Row="4" RowDefinitions="Auto,*" Margin="0,10,0,0">
                <TextBlock Grid.Row="0" Text="Completed:" FontWeight="SemiBold"
                           Margin="0,0,0,4" />
                <Border Grid.Row="1"
                        BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        BorderThickness="1" CornerRadius="4">
                    <ScrollViewer>
                        <ItemsControl ItemsSource="{Binding CompletedPlugins}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:PluginCleaningResult">
                                    <Border Padding="8,4"
                                            BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                            BorderThickness="0,0,0,1">
                                        <Grid ColumnDefinitions="*,Auto,Auto">
                                            <!-- Plugin name -->
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding PluginName}"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center" />

                                            <!-- Summary (ITMs, UDRs, etc.) -->
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding Summary}"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                       FontSize="12"
                                                       Margin="10,0"
                                                       VerticalAlignment="Center" />

                                            <!-- Log parse warning indicator -->
                                            <TextBlock Grid.Column="2"
                                                       Text="!"
                                                       FontWeight="Bold"
                                                       Foreground="#DAA520"
                                                       FontSize="14"
                                                       VerticalAlignment="Center"
                                                       IsVisible="{Binding HasLogParseWarning}"
                                                       ToolTip.Tip="{Binding LogParseWarning}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>
            </Grid>

            <!-- Row 5: Stop Button / Stopping Indicator -->
            <StackPanel Grid.Row="5"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Spacing="10"
                        Margin="0,10,0,0">
                <!-- Stopping spinner (visible during termination) -->
                <StackPanel Orientation="Horizontal"
                            Spacing="8"
                            VerticalAlignment="Center"
                            IsVisible="{Binding IsTerminating}">
                    <ProgressBar IsIndeterminate="True"
                                 Width="80" Height="14" />
                    <TextBlock Text="Stopping..."
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               FontSize="12" />
                </StackPanel>
                <Button Content="Stop"
                        Command="{Binding StopCommand}"
                        MinWidth="100" />
            </StackPanel>
        </Grid>

        <!-- ==================== RESULTS SUMMARY PANEL ==================== -->
        <!-- Visible when showing results AND NOT in preview mode -->
        <Grid Margin="20" RowDefinitions="Auto,Auto,Auto,*,Auto"
              IsVisible="{Binding !IsPreviewMode, FallbackValue=True}">

            <!-- Row 0: Session Header -->
            <StackPanel Grid.Row="0" Spacing="4"
                        IsVisible="{Binding IsShowingResults}">
                <!-- Header text toggles between Complete/Cancelled -->
                <TextBlock Text="Cleaning Complete"
                           FontSize="20" FontWeight="Bold"
                           IsVisible="{Binding !WasCancelled}" />
                <TextBlock Text="Cleaning Cancelled"
                           FontSize="20" FontWeight="Bold"
                           Foreground="#DAA520"
                           IsVisible="{Binding WasCancelled}" />
                <TextBlock Text="{Binding SessionSummaryText}"
                           FontSize="13"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
            </StackPanel>

            <!-- Row 1: Plugin Count Totals -->
            <Border Grid.Row="1"
                    IsVisible="{Binding IsShowingResults}"
                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                    CornerRadius="4" Padding="15" Margin="0,10,0,0">
                <Grid ColumnDefinitions="*,*,*">
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding CleanedCount}"
                                   FontSize="24" FontWeight="Bold"
                                   Foreground="Green"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Cleaned" FontSize="12"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>

                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding SkippedCount}"
                                   FontSize="24" FontWeight="Bold"
                                   Foreground="Orange"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Skipped" FontSize="12"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>

                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding FailedCount}"
                                   FontSize="24" FontWeight="Bold"
                                   Foreground="Red"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Failed" FontSize="12"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Row 2: Cleaning Stats Totals -->
            <Border Grid.Row="2"
                    IsVisible="{Binding IsShowingResults}"
                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                    CornerRadius="4" Padding="15" Margin="0,8,0,0">
                <Grid ColumnDefinitions="*,*,*">
                    <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding TotalItmCount}"
                                   FontSize="20" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="ITMs Removed" FontSize="11"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>

                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding TotalUdrCount}"
                                   FontSize="20" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="UDRs Fixed" FontSize="11"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>

                    <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding TotalNavCount}"
                                   FontSize="20" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Navmeshes" FontSize="11"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Row 3: Per-Plugin Results List -->
            <Grid Grid.Row="3" RowDefinitions="Auto,*" Margin="0,10,0,0"
                  IsVisible="{Binding IsShowingResults}">
                <TextBlock Grid.Row="0" Text="Plugin Details:" FontWeight="SemiBold"
                           Margin="0,0,0,4" />
                <Border Grid.Row="1"
                        BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        BorderThickness="1" CornerRadius="4">
                    <ScrollViewer>
                        <ItemsControl ItemsSource="{Binding CompletedPlugins}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:PluginCleaningResult">
                                    <Border Padding="8,4"
                                            BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                            BorderThickness="0,0,0,1">
                                        <Grid ColumnDefinitions="*,Auto,Auto">
                                            <!-- Plugin name -->
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding PluginName}"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center" />

                                            <!-- Summary -->
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding Summary}"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                       FontSize="12"
                                                       Margin="10,0"
                                                       VerticalAlignment="Center" />

                                            <!-- Log parse warning indicator -->
                                            <TextBlock Grid.Column="2"
                                                       Text="!"
                                                       FontWeight="Bold"
                                                       Foreground="#DAA520"
                                                       FontSize="14"
                                                       VerticalAlignment="Center"
                                                       IsVisible="{Binding HasLogParseWarning}"
                                                       ToolTip.Tip="{Binding LogParseWarning}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>
            </Grid>

            <!-- Row 4: Close Button -->
            <StackPanel Grid.Row="4"
                        IsVisible="{Binding IsShowingResults}"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,10,0,0">
                <Button Content="Close"
                        Command="{Binding CloseCommand}"
                        IsDefault="True"
                        MinWidth="100" />
            </StackPanel>
        </Grid>

        <!-- ==================== DRY-RUN PREVIEW PANEL ==================== -->
        <Grid Margin="20" RowDefinitions="Auto,Auto,Auto,*,Auto"
              IsVisible="{Binding IsPreviewMode}">

            <!-- Row 0: Preview Header -->
            <StackPanel Grid.Row="0" Spacing="4">
                <TextBlock Text="Dry-Run Preview"
                           FontSize="20" FontWeight="Bold"
                           Foreground="#1565C0" />
            </StackPanel>

            <!-- Row 1: Disclaimer Banner -->
            <Border Grid.Row="1"
                    Background="#E3F2FD"
                    BorderBrush="#1565C0"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="10,8"
                    Margin="0,10,0,0">
                <TextBlock Text="{Binding PreviewDisclaimer}"
                           TextWrapping="Wrap"
                           Foreground="#0D47A1"
                           FontSize="12" />
            </Border>

            <!-- Row 2: Summary Bar -->
            <Border Grid.Row="2"
                    Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                    CornerRadius="4" Padding="10,8"
                    Margin="0,8,0,0">
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock FontSize="13" FontWeight="SemiBold"
                               Foreground="#2D7D46">
                        <Run Text="{Binding WillCleanCount}"/><Run Text=" will be cleaned"/>
                    </TextBlock>
                    <TextBlock Text=", " FontSize="13" />
                    <TextBlock FontSize="13" FontWeight="SemiBold"
                               Foreground="#E65100">
                        <Run Text="{Binding WillSkipCount}"/><Run Text=" will be skipped"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Row 3: Per-Plugin Preview List -->
            <Grid Grid.Row="3" RowDefinitions="Auto,*" Margin="0,10,0,0">
                <TextBlock Grid.Row="0" Text="Plugin Details:" FontWeight="SemiBold"
                           Margin="0,0,0,4" />
                <Border Grid.Row="1"
                        BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        BorderThickness="1" CornerRadius="4">
                    <ScrollViewer>
                        <ItemsControl ItemsSource="{Binding DryRunResults}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:DryRunResult">
                                    <Border Padding="8,4"
                                            BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                            BorderThickness="0,0,0,1">
                                        <Grid ColumnDefinitions="*,Auto,Auto">
                                            <!-- Plugin name -->
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding PluginName}"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center" />

                                            <!-- Status text -->
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding Status}"
                                                       FontWeight="SemiBold"
                                                       FontSize="12"
                                                       Margin="10,0"
                                                       VerticalAlignment="Center" />

                                            <!-- Reason -->
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding Reason}"
                                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                       FontSize="12"
                                                       Margin="10,0"
                                                       VerticalAlignment="Center" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>
            </Grid>

            <!-- Row 4: Close Button -->
            <StackPanel Grid.Row="4"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,10,0,0">
                <Button Content="Close"
                        Command="{Binding CloseCommand}"
                        IsDefault="True"
                        MinWidth="100" />
            </StackPanel>
        </Grid>
    </Panel>
</Window>
