<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AutoQAC.ViewModels"
        xmlns:mw="using:AutoQAC.ViewModels.MainWindow"
        xmlns:m="using:AutoQAC.Models"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        d:DesignWidth="900" d:DesignHeight="600"
        x:Class="AutoQAC.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        d:DataContext="{d:DesignInstance vm:MainWindowViewModel, IsDesignTimeCreatable=False}"
        Title="AutoQAC - Plugin Auto Cleaning Tool"
        Width="900" Height="600"
        MinWidth="700" MinHeight="400"
        Icon="/Assets/avalonia-logo.ico">


    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Exit" Command="{Binding Commands.ExitCommand}" />
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Settings..." Command="{Binding Commands.ShowSettingsCommand}" />
                <MenuItem Header="Skip _List..." Command="{Binding Commands.ShowSkipListCommand}" />
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Command="{Binding Commands.ShowAboutCommand}" />
            </MenuItem>
        </Menu>

        <!-- Migration Warning Banner -->
        <Border DockPanel.Dock="Top"
                IsVisible="{Binding Configuration.HasMigrationWarning}"
                Background="#FFEBEE"
                BorderBrush="#E53935"
                BorderThickness="0,0,0,2"
                Padding="10,8">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <TextBlock Grid.Column="0"
                           Text="&#x26A0;"
                           FontSize="16"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0" />
                <TextBlock Grid.Column="1"
                           Text="{Binding Configuration.MigrationWarningMessage}"
                           TextWrapping="Wrap"
                           VerticalAlignment="Center"
                           Foreground="#B71C1C" />
                <Button Grid.Column="2"
                        Content="Dismiss"
                        Command="{Binding Configuration.DismissMigrationWarningCommand}"
                        Padding="8,3"
                        FontSize="11"
                        Margin="10,0,0,0"
                        VerticalAlignment="Center" />
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                BorderThickness="0,1,0,0"
                Padding="5">
            <TextBlock Text="{Binding Configuration.StatusText}" />
        </Border>

        <!-- Main Content -->
        <Grid Margin="10" RowDefinitions="Auto,Auto,*,Auto">

            <!-- Configuration Panel -->
            <StackPanel Grid.Row="0" Spacing="10">
                <TextBlock Text="Configuration"
                           FontSize="16" FontWeight="Bold" />

                <!-- Game Selection -->
                <Grid ColumnDefinitions="120,*,Auto">
                    <TextBlock Grid.Column="0" Text="Game:"
                               VerticalAlignment="Center" />
                    <ComboBox Grid.Column="1"
                              ItemsSource="{Binding Configuration.AvailableGames}"
                              SelectedItem="{Binding Configuration.SelectedGame}"
                              HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource GameTypeDisplayConverter}}" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    <TextBlock Grid.Column="2"
                               Text="{Binding Configuration.IsMutagenSupported, StringFormat='Mutagen: {0}'}"
                               VerticalAlignment="Center"
                               Margin="10,0,0,0"
                               FontSize="11"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
                </Grid>

                <!-- Data Folder (only for Mutagen-supported games) -->
                <Grid ColumnDefinitions="120,*,Auto,Auto,Auto"
                      IsVisible="{Binding Configuration.IsMutagenSupported}">
                    <TextBlock Grid.Column="0" Text="Data Folder:"
                               VerticalAlignment="Center" />
                    <TextBox Grid.Column="1"
                             Text="{Binding Configuration.GameDataFolder}"
                             IsReadOnly="True"
                             Watermark="Auto-detected from registry" />
                    <Panel Grid.Column="2" Width="24" VerticalAlignment="Center" Margin="5,0,0,0">
                        <TextBlock Text="&#x2713;"
                                   FontSize="16" FontWeight="Bold"
                                   Foreground="#4CAF50"
                                   HorizontalAlignment="Center"
                                   IsVisible="{Binding Configuration.IsGameDataFolderValid, Converter={StaticResource IsTrueConverter}}" />
                        <TextBlock Text="&#x2717;"
                                   FontSize="16" FontWeight="Bold"
                                   Foreground="#F44336"
                                   HorizontalAlignment="Center"
                                   IsVisible="{Binding Configuration.IsGameDataFolderValid, Converter={StaticResource IsFalseConverter}}" />
                    </Panel>
                    <Button Grid.Column="3"
                            Content="Override..."
                            Command="{Binding Configuration.ConfigureGameDataFolderCommand}"
                            Margin="5,0,0,0" />
                    <Button Grid.Column="4"
                            Content="Reset"
                            Command="{Binding Configuration.ClearGameDataFolderOverrideCommand}"
                            IsVisible="{Binding Configuration.HasGameDataFolderOverride}"
                            Margin="5,0,0,0" />
                </Grid>

                <Expander Header="Advanced: Load Order"
                          IsExpanded="False"
                          IsVisible="{Binding Configuration.RequiresLoadOrderFile}">
                    <Grid ColumnDefinitions="120,*,Auto,Auto" Margin="0,5">
                        <TextBlock Grid.Column="0" Text="Load Order:"
                                   VerticalAlignment="Center" />
                        <TextBox Grid.Column="1"
                                 Text="{Binding Configuration.LoadOrderPath}"
                                 IsReadOnly="True"
                                 Watermark="Auto-detected or not configured" />
                        <Panel Grid.Column="2" Width="24" VerticalAlignment="Center" Margin="5,0,0,0">
                            <TextBlock Text="&#x2713;"
                                       FontSize="16" FontWeight="Bold"
                                       Foreground="#4CAF50"
                                       HorizontalAlignment="Center"
                                       IsVisible="{Binding Configuration.IsLoadOrderPathValid, Converter={StaticResource IsTrueConverter}}" />
                            <TextBlock Text="&#x2717;"
                                       FontSize="16" FontWeight="Bold"
                                       Foreground="#F44336"
                                       HorizontalAlignment="Center"
                                       IsVisible="{Binding Configuration.IsLoadOrderPathValid, Converter={StaticResource IsFalseConverter}}" />
                        </Panel>
                        <Button Grid.Column="3"
                                Content="Browse..."
                                Command="{Binding Configuration.ConfigureLoadOrderCommand}"
                                Margin="5,0,0,0" />
                    </Grid>
                </Expander>

                <Grid ColumnDefinitions="120,*,Auto,Auto">
                    <TextBlock Grid.Column="0" Text="xEdit:"
                               VerticalAlignment="Center" />
                    <TextBox Grid.Column="1"
                             Text="{Binding Configuration.XEditPath}"
                             IsReadOnly="True"
                             Watermark="Not configured" />
                    <Panel Grid.Column="2" Width="24" VerticalAlignment="Center" Margin="5,0,0,0">
                        <TextBlock Text="&#x2713;"
                                   FontSize="16" FontWeight="Bold"
                                   Foreground="#4CAF50"
                                   HorizontalAlignment="Center"
                                   IsVisible="{Binding Configuration.IsXEditPathValid, Converter={StaticResource IsTrueConverter}}" />
                        <TextBlock Text="&#x2717;"
                                   FontSize="16" FontWeight="Bold"
                                   Foreground="#F44336"
                                   HorizontalAlignment="Center"
                                   IsVisible="{Binding Configuration.IsXEditPathValid, Converter={StaticResource IsFalseConverter}}" />
                    </Panel>
                    <Button Grid.Column="3"
                            Content="Browse..."
                            Command="{Binding Configuration.ConfigureXEditCommand}"
                            Margin="5,0,0,0" />
                </Grid>

                <Grid ColumnDefinitions="120,*,Auto,Auto">
                    <TextBlock Grid.Column="0" Text="Mod Organizer 2:"
                               VerticalAlignment="Center" />
                    <TextBox Grid.Column="1"
                             Text="{Binding Configuration.Mo2Path}"
                             IsReadOnly="True"
                             Watermark="Optional - for MO2 mode" />
                    <Panel Grid.Column="2" Width="24" VerticalAlignment="Center" Margin="5,0,0,0">
                        <TextBlock Text="&#x2713;"
                                   FontSize="16" FontWeight="Bold"
                                   Foreground="#4CAF50"
                                   HorizontalAlignment="Center"
                                   IsVisible="{Binding Configuration.IsMo2PathValid, Converter={StaticResource IsTrueConverter}}" />
                        <TextBlock Text="&#x2717;"
                                   FontSize="16" FontWeight="Bold"
                                   Foreground="#F44336"
                                   HorizontalAlignment="Center"
                                   IsVisible="{Binding Configuration.IsMo2PathValid, Converter={StaticResource IsFalseConverter}}" />
                    </Panel>
                    <Button Grid.Column="3"
                            Content="Browse..."
                            Command="{Binding Configuration.ConfigureMo2Command}"
                            Margin="5,0,0,0" />
                </Grid>

                <StackPanel Orientation="Horizontal" Spacing="10">
                    <CheckBox Content="MO2 Mode"
                              IsChecked="{Binding Configuration.Mo2ModeEnabled}" />
                    <CheckBox Content="Partial Forms (Experimental)"
                              IsChecked="{Binding Configuration.PartialFormsEnabled}"
                              Command="{Binding Configuration.TogglePartialFormsCommand}" />
                    <CheckBox Content="Disable Skip Lists"
                              IsChecked="{Binding Configuration.DisableSkipListsEnabled}"
                              ToolTip.Tip="Show all plugins, ignoring skip and ignore lists" />
                    <Button Content="Reset Settings"
                            Command="{Binding Configuration.ResetSettingsCommand}"
                            VerticalAlignment="Center" />
                </StackPanel>
            </StackPanel>

            <!-- Validation Error Panel -->
            <Border Grid.Row="1"
                    IsVisible="{Binding Commands.HasValidationErrors}"
                    Background="#FFF2CC"
                    BorderBrush="#E6A817"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="10"
                    Margin="0,5">
                <StackPanel Spacing="5">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0"
                                   Text="Cannot start cleaning:"
                                   FontWeight="Bold"
                                   Foreground="#8B4513" />
                        <Button Grid.Column="1"
                                Content="Dismiss"
                                Command="{Binding Commands.DismissValidationCommand}"
                                Padding="5,1"
                                FontSize="11" />
                    </Grid>
                    <ItemsControl ItemsSource="{Binding Commands.ValidationErrors}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="m:ValidationError">
                                <StackPanel Margin="0,3">
                                    <TextBlock Text="{Binding Title}"
                                               FontWeight="SemiBold"
                                               Foreground="#8B4513" />
                                    <TextBlock Text="{Binding FixStep}"
                                               TextWrapping="Wrap"
                                               Foreground="#5D4037"
                                               FontSize="12" />
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Plugin List -->
            <Border Grid.Row="2"
                    BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Margin="0,10,0,10">
                <Grid RowDefinitions="Auto,*">
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto">
                        <TextBlock Grid.Column="0"
                                   Text="Plugins to Clean"
                                   FontSize="14" FontWeight="SemiBold"
                                   Margin="10,5"
                                   VerticalAlignment="Center" />
                        <Button Grid.Column="1"
                                Content="All"
                                Command="{Binding PluginList.SelectAllCommand}"
                                Margin="5,5,2,5"
                                Padding="8,3"
                                FontSize="11"
                                ToolTip.Tip="Select all plugins" />
                        <Button Grid.Column="2"
                                Content="None"
                                Command="{Binding PluginList.DeselectAllCommand}"
                                Margin="2,5,5,5"
                                Padding="8,3"
                                FontSize="11"
                                ToolTip.Tip="Deselect all plugins" />
                        <Button Grid.Column="3"
                                Content="Manage Skip List"
                                Command="{Binding Commands.ShowSkipListCommand}"
                                Margin="5"
                                Padding="10,3"
                                FontSize="11" />
                    </Grid>

                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding PluginList.PluginsToClean}"
                             SelectedItem="{Binding PluginList.SelectedPlugin}"
                             Margin="5">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsSelected}"
                                          Content="{Binding FileName}"
                                          Margin="2" />
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- Control Buttons -->
            <Grid Grid.Row="3" ColumnDefinitions="Auto,*,Auto">
                <!-- Left-aligned buttons -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal"
                            Spacing="10">
                    <Button Content="Restore Backups"
                            Command="{Binding Commands.RestoreBackupsCommand}"
                            ToolTip.Tip="Browse and restore plugins from previous backup sessions"
                            MinWidth="120" />
                </StackPanel>

                <!-- Right-aligned buttons -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="10">
                    <Button Content="Preview"
                            Command="{Binding Commands.PreviewCommand}"
                            ToolTip.Tip="Preview which plugins will be cleaned or skipped (without running xEdit)"
                            MinWidth="120" />
                    <Button Content="Start Cleaning"
                            Command="{Binding Commands.StartCleaningCommand}"
                            IsEnabled="{Binding Commands.CanStartCleaning}"
                            MinWidth="120" />
                    <Button Content="Stop"
                            Command="{Binding Commands.StopCleaningCommand}"
                            IsEnabled="{Binding Commands.IsCleaning}"
                            MinWidth="120" />
                </StackPanel>
            </Grid>
        </Grid>
    </DockPanel>
</Window>
