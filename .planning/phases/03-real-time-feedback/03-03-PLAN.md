---
phase: 03-real-time-feedback
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - AutoQAC/Models/ValidationError.cs
  - AutoQAC/ViewModels/MainWindowViewModel.cs
  - AutoQAC/Views/MainWindow.axaml
autonomous: true

must_haves:
  truths:
    - "When user clicks Start Cleaning with missing/invalid config, an inline error panel appears in the main window"
    - "The error panel is non-modal and shows all validation errors at once"
    - "Each validation error includes a title and actionable fix step telling the user exactly what to do"
    - "Validation runs only when the user clicks Clean, not on startup or settings change"
    - "The user can dismiss the validation error panel"
    - "If validation passes, cleaning starts normally with no panel shown"
  artifacts:
    - path: "AutoQAC/Models/ValidationError.cs"
      provides: "ValidationError record with Title, Message, FixStep"
      exports: ["ValidationError"]
    - path: "AutoQAC/ViewModels/MainWindowViewModel.cs"
      provides: "ValidationErrors collection, HasValidationErrors, DismissValidationCommand, pre-clean validation"
      contains: "ValidatePreClean"
    - path: "AutoQAC/Views/MainWindow.axaml"
      provides: "Inline validation error panel with ItemsControl"
      contains: "HasValidationErrors"
  key_links:
    - from: "AutoQAC/ViewModels/MainWindowViewModel.cs"
      to: "ValidationError"
      via: "ValidatePreClean returns List<ValidationError>"
      pattern: "ValidatePreClean"
    - from: "AutoQAC/ViewModels/MainWindowViewModel.cs"
      to: "StartCleaningAsync"
      via: "Validation called before orchestrator.StartCleaningAsync"
      pattern: "ValidatePreClean.*StartCleaningAsync"
    - from: "AutoQAC/Views/MainWindow.axaml"
      to: "ValidationErrors"
      via: "ItemsControl binding"
      pattern: "ItemsSource.*ValidationErrors"
---

<objective>
Add inline pre-clean validation with actionable error messages to the main window.

Purpose: Replace the current modal error dialogs for configuration validation with a non-modal inline error panel. When the user clicks "Start Cleaning" and the environment is misconfigured (missing xEdit, bad load order path, invalid MO2 config), all validation errors are shown at once in the panel with specific fix instructions. This satisfies PROG-03 (enhanced validation messages).

Output: New ValidationError model, pre-clean validation method on MainWindowViewModel, inline error panel in MainWindow.axaml.
</objective>

<execution_context>
@C:\Users\evild\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\evild\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-feedback/03-RESEARCH.md

Key existing files to read before implementing:
@AutoQAC/ViewModels/MainWindowViewModel.cs
@AutoQAC/Views/MainWindow.axaml
@AutoQAC/Services/State/IStateService.cs
@AutoQAC/Models/AppState.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ValidationError model and add pre-clean validation to MainWindowViewModel</name>
  <files>
    AutoQAC/Models/ValidationError.cs
    AutoQAC/ViewModels/MainWindowViewModel.cs
  </files>
  <action>
    1. Create `AutoQAC/Models/ValidationError.cs`:
       ```csharp
       namespace AutoQAC.Models;

       /// <summary>
       /// Represents a pre-clean validation error with actionable fix guidance.
       /// </summary>
       public sealed record ValidationError(string Title, string Message, string FixStep);
       ```

    2. In `MainWindowViewModel.cs`, add these properties and command:
       ```csharp
       private ObservableCollection<ValidationError> _validationErrors = new();
       public ObservableCollection<ValidationError> ValidationErrors
       {
           get => _validationErrors;
           set => this.RaiseAndSetIfChanged(ref _validationErrors, value);
       }

       private bool _hasValidationErrors;
       public bool HasValidationErrors
       {
           get => _hasValidationErrors;
           set => this.RaiseAndSetIfChanged(ref _hasValidationErrors, value);
       }

       public ReactiveCommand<Unit, Unit> DismissValidationCommand { get; }
       ```

    3. Initialize `DismissValidationCommand` in the constructor:
       ```csharp
       DismissValidationCommand = ReactiveCommand.Create(() =>
       {
           ValidationErrors.Clear();
           HasValidationErrors = false;
       });
       ```

    4. Add a `ValidatePreClean()` method to MainWindowViewModel:
       ```csharp
       private List<ValidationError> ValidatePreClean()
       {
           var errors = new List<ValidationError>();
           var state = _stateService.CurrentState;

           // xEdit validation
           if (string.IsNullOrEmpty(state.XEditExecutablePath))
           {
               errors.Add(new ValidationError(
                   "xEdit not configured",
                   "xEdit executable path is not set.",
                   "Go to Edit > Settings and set the xEdit Path to your xEdit executable (SSEEdit.exe, FO4Edit.exe, etc.)."));
           }
           else if (!System.IO.File.Exists(state.XEditExecutablePath))
           {
               errors.Add(new ValidationError(
                   "xEdit not found",
                   $"xEdit not found at: {state.XEditExecutablePath}",
                   "Go to Edit > Settings and update the xEdit Path to the correct location."));
           }

           // Load order / plugins validation
           var hasPlugins = state.PluginsToClean.Count > 0;
           if (!hasPlugins)
           {
               errors.Add(new ValidationError(
                   "No plugins loaded",
                   "No plugins are available for cleaning.",
                   "Select a game from the dropdown, or browse for a load order file."));
           }
           else
           {
               var selectedCount = state.PluginsToClean.Count(p => p.IsSelected && !p.IsInSkipList);
               if (selectedCount == 0)
               {
                   errors.Add(new ValidationError(
                       "No plugins selected",
                       "All plugins are either deselected or in the skip list.",
                       "Select at least one plugin to clean, or check your skip list settings."));
               }
           }

           // MO2 validation (only if MO2 mode enabled)
           if (state.Mo2ModeEnabled)
           {
               if (string.IsNullOrEmpty(state.Mo2ExecutablePath))
               {
                   errors.Add(new ValidationError(
                       "MO2 not configured",
                       "MO2 mode is enabled but no MO2 executable path is set.",
                       "Go to Edit > Settings and set the MO2 Path, or disable MO2 mode if not using Mod Organizer 2."));
               }
               else if (!System.IO.File.Exists(state.Mo2ExecutablePath))
               {
                   errors.Add(new ValidationError(
                       "MO2 not found",
                       $"MO2 executable not found at: {state.Mo2ExecutablePath}",
                       "Check the MO2 executable path in Edit > Settings, or disable MO2 mode."));
               }
           }

           return errors;
       }
       ```

    5. Modify `StartCleaningAsync()`:
       - REMOVE the existing xEdit path validation at the top (the two `if` blocks checking XEditPath that show modal dialogs)
       - BEFORE calling `_orchestrator.StartCleaningAsync`, call `ValidatePreClean()`:
         ```csharp
         // Clear previous validation errors
         ValidationErrors.Clear();
         HasValidationErrors = false;

         // Run pre-clean validation
         var errors = ValidatePreClean();
         if (errors.Count > 0)
         {
             foreach (var error in errors)
                 ValidationErrors.Add(error);
             HasValidationErrors = true;
             return; // Do not start cleaning
         }
         ```
       - Keep the existing try/catch around `_orchestrator.StartCleaningAsync` for runtime errors
       - The `catch (InvalidOperationException ex) when (ex.Message.Contains("Configuration is invalid"))` block can remain as a fallback for orchestrator-level validation, but convert it to add an inline error instead of a modal dialog:
         ```csharp
         catch (InvalidOperationException ex)
         {
             ValidationErrors.Clear();
             ValidationErrors.Add(new ValidationError(
                 "Configuration error",
                 ex.Message,
                 "Check your configuration in Edit > Settings."));
             HasValidationErrors = true;
             StatusText = "Configuration error";
         }
         ```
       - Keep the generic `catch (Exception ex)` for unexpected errors (those still use modal dialog since they're truly unexpected)

    6. Also clear validation errors when cleaning starts successfully (after the validation passes):
       ```csharp
       // Clear any lingering validation errors from a previous attempt
       ValidationErrors.Clear();
       HasValidationErrors = false;
       ```

    Add `using System.Linq;` if not already present (needed for `.Count(p => ...)` in plugin selection check).
    Add `using AutoQAC.Models;` import for ValidationError (likely already present for other models).
  </action>
  <verify>
    `dotnet build` succeeds. MainWindowViewModel has ValidatePreClean method, ValidationErrors/HasValidationErrors properties, and DismissValidationCommand. The old modal dialog validation is replaced with inline validation.
  </verify>
  <done>
    ValidationError record exists with Title, Message, FixStep. MainWindowViewModel.StartCleaningAsync calls ValidatePreClean before starting the orchestrator. Validation errors are shown in the ValidationErrors ObservableCollection. Modal dialogs for xEdit path validation are removed. DismissValidationCommand clears the error panel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline validation error panel to MainWindow XAML</name>
  <files>AutoQAC/Views/MainWindow.axaml</files>
  <action>
    Add an inline validation error panel to MainWindow.axaml. Read the existing file first.

    Insert the validation error panel between the Configuration panel (Grid.Row="0") and the Plugin List (Grid.Row="1"). To do this, update the main Grid to have 4 rows instead of 3: `RowDefinitions="Auto,Auto,*,Auto"` and shift the Plugin List to Grid.Row="2" and the Control Buttons to Grid.Row="3".

    **Validation Error Panel** (Grid.Row="1"):
    ```xml
    <!-- Validation Error Panel -->
    <Border Grid.Row="1"
            IsVisible="{Binding HasValidationErrors}"
            Background="#FFF2CC"
            BorderBrush="#E6A817"
            BorderThickness="1"
            CornerRadius="4"
            Padding="10"
            Margin="0,5">
        <StackPanel Spacing="5">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0"
                           Text="Cannot start cleaning:"
                           FontWeight="Bold"
                           Foreground="#8B4513" />
                <Button Grid.Column="1"
                        Content="Dismiss"
                        Command="{Binding DismissValidationCommand}"
                        Padding="5,1"
                        FontSize="11" />
            </Grid>
            <ItemsControl ItemsSource="{Binding ValidationErrors}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="0,3">
                            <TextBlock Text="{Binding Title}"
                                       FontWeight="SemiBold"
                                       Foreground="#8B4513" />
                            <TextBlock Text="{Binding FixStep}"
                                       TextWrapping="Wrap"
                                       Foreground="#5D4037"
                                       FontSize="12" />
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>
    </Border>
    ```

    Also update the DataTemplate's DataType. Since the DataTemplate is inside ItemsControl within MainWindow (which has x:DataType="vm:MainWindowViewModel"), you need to either:
    - Add an xmlns for models: `xmlns:m="using:AutoQAC.Models"` in the Window tag
    - Set the DataTemplate's DataType: `<DataTemplate x:DataType="m:ValidationError">`

    Make sure the Grid.Row assignments are updated for all existing children:
    - Configuration Panel: Grid.Row="0" (unchanged)
    - Validation Error Panel: Grid.Row="1" (new)
    - Plugin List Border: Grid.Row="2" (was Row="1")
    - Control Buttons StackPanel: Grid.Row="3" (was Row="2")
  </action>
  <verify>
    `dotnet build` succeeds. The AXAML compiles correctly with no binding errors. Check that the Grid has 4 rows and all Grid.Row assignments are correct. Verify the DataTemplate has x:DataType set for compiled bindings.
  </verify>
  <done>
    MainWindow.axaml has an inline validation error panel between the configuration panel and the plugin list. The panel shows when HasValidationErrors is true. Each error displays Title (bold) and FixStep (actionable text). A Dismiss button clears the panel. Grid rows are correctly numbered with the new row inserted.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` -- project compiles with no errors
2. `dotnet test` -- all tests pass
3. Verify MainWindow.axaml has validation error panel with ItemsControl bound to ValidationErrors
4. Verify MainWindowViewModel.StartCleaningAsync calls ValidatePreClean before orchestrator
5. Verify old modal dialog validation (the two `if` blocks for XEditPath) is removed from StartCleaningAsync
6. Verify validation checks: xEdit path (empty + not found), plugins (none loaded + none selected), MO2 (enabled but not configured + not found)
7. Verify each ValidationError has actionable FixStep text
8. Verify DismissValidationCommand clears ValidationErrors and sets HasValidationErrors = false
</verification>

<success_criteria>
- Pre-clean validation errors shown as inline error panel (non-modal, per user decision)
- Validation runs only when user clicks Clean (per user decision)
- Error messages include actionable fix steps (per user decision)
- Multiple validation errors shown all at once (per user decision)
- Panel has Dismiss button to clear errors
- Validation covers: xEdit path, load order/plugins, MO2 config
- Old modal dialog validation removed from StartCleaningAsync
- XAML compiles with correct bindings and Grid row assignments
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-feedback/03-03-SUMMARY.md`
</output>
