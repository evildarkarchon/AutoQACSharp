---
phase: 03-real-time-feedback
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - AutoQAC/ViewModels/ProgressViewModel.cs
  - AutoQAC/Views/ProgressWindow.axaml
  - AutoQAC/Views/ProgressWindow.axaml.cs
autonomous: true

must_haves:
  truths:
    - "During cleaning, the progress window shows live ITM/UDR/Nav counter badges next to the current plugin name"
    - "A compact summary bar shows 'X/Y plugins -- Z skipped, W failed' during and after cleaning"
    - "A progress bar fills based on plugins completed out of total"
    - "Completed plugin stats accumulate below the current plugin and persist through the session"
    - "When cleaning finishes, the progress window transforms into a results summary showing totals and per-plugin stats"
    - "On cancel, partial summary is shown with clear indication of what was cancelled"
    - "If log file parse failed for a plugin, a warning icon with tooltip appears inline"
    - "Sessions with 100+ plugins do not cause UI lag"
  artifacts:
    - path: "AutoQAC/ViewModels/ProgressViewModel.cs"
      provides: "Per-plugin stats, session counters, IsShowingResults, throttled subscriptions"
      contains: "IsShowingResults"
    - path: "AutoQAC/Views/ProgressWindow.axaml"
      provides: "Counter badges, summary bar, dual-panel active/results layout"
      contains: "ITM:"
    - path: "AutoQAC/Views/ProgressWindow.axaml.cs"
      provides: "Close prevention during cleaning"
      contains: "OnClosing"
  key_links:
    - from: "AutoQAC/ViewModels/ProgressViewModel.cs"
      to: "IStateService.DetailedPluginResult"
      via: "Rx subscription in constructor"
      pattern: "DetailedPluginResult"
    - from: "AutoQAC/ViewModels/ProgressViewModel.cs"
      to: "IStateService.CleaningCompleted"
      via: "Rx subscription setting IsShowingResults = true"
      pattern: "IsShowingResults\\s*=\\s*true"
    - from: "AutoQAC/ViewModels/ProgressViewModel.cs"
      to: "IStateService.StateChanged"
      via: "Sample(100ms) throttled subscription"
      pattern: "Sample"
---

<objective>
Redesign the progress window to show live per-plugin cleaning statistics and transform into a results summary on completion.

Purpose: Replace the current basic progress display with live counter badges (ITM: X, UDR: X, Nav: X), a compact summary bar, an accumulated completed plugins list, and a results summary view that appears when cleaning finishes. This is the primary user-facing deliverable of Phase 3.

Output: Fully redesigned ProgressViewModel with per-plugin stats, throttled state subscriptions, and dual-mode XAML (active cleaning view + results summary view).
</objective>

<execution_context>
@C:\Users\evild\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\evild\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-real-time-feedback/03-RESEARCH.md
@.planning/phases/03-real-time-feedback/03-01-SUMMARY.md

Key existing files to read before implementing:
@AutoQAC/ViewModels/ProgressViewModel.cs
@AutoQAC/Views/ProgressWindow.axaml
@AutoQAC/Views/ProgressWindow.axaml.cs
@AutoQAC/Services/State/IStateService.cs
@AutoQAC/Models/PluginCleaningResult.cs
@AutoQAC/Models/CleaningSessionResult.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich ProgressViewModel with per-plugin stats and dual-mode state</name>
  <files>AutoQAC/ViewModels/ProgressViewModel.cs</files>
  <action>
    Rewrite ProgressViewModel to support live counter badges, accumulated results, throttled subscriptions, and results summary mode. Read the existing file first, then apply these changes:

    **New properties to add:**
    - `int CurrentItmCount` / `int CurrentUdrCount` / `int CurrentNavCount` -- per-plugin ITM/UDR/Nav badges (from the LATEST completed plugin's stats, or from the currently-being-cleaned plugin once its log is parsed)
    - `bool HasCurrentPluginStats` -- true when counter badges should be visible
    - `ObservableCollection<PluginCleaningResult> CompletedPlugins` -- accumulated list of completed plugin results (replaces LogOutput string)
    - `bool IsShowingResults` -- toggles between active cleaning view and results summary view
    - `CleaningSessionResult? SessionResult` -- populated when cleaning finishes
    - `bool WasCancelled` -- from session result, for displaying cancel indication
    - `string SessionSummaryText` -- e.g., "Completed: 45 cleaned, 2 skipped, 1 failed" or "Cancelled after 12 of 87 plugins"
    - `int TotalItmCount` / `int TotalUdrCount` / `int TotalNavCount` -- session-wide totals for results summary

    **Remove:**
    - `LogOutput` property (string concatenation anti-pattern per research)

    **Subscription changes:**
    1. Throttle `StateChanged` subscription using `.Sample(TimeSpan.FromMilliseconds(100))` merged with `.Where(s => !s.IsCleaning)` to ensure final state gets through:
       ```csharp
       var throttledState = _stateService.StateChanged
           .Sample(TimeSpan.FromMilliseconds(100))
           .Merge(_stateService.StateChanged.Where(s => !s.IsCleaning))
           .DistinctUntilChanged()
           .ObserveOn(RxApp.MainThreadScheduler);
       ```

    2. Subscribe to `DetailedPluginResult` (NOT throttled -- fires once per plugin):
       ```csharp
       _stateService.DetailedPluginResult
           .ObserveOn(RxApp.MainThreadScheduler)
           .Subscribe(OnDetailedResult);
       ```
       In `OnDetailedResult`:
       - Add result to `CompletedPlugins` collection
       - Update CurrentItmCount/UdrCount/NavCount from `result.Statistics`
       - Set `HasCurrentPluginStats = result.Statistics != null`
       - Update SkippedCount/FailedCount/CleanedCount from running tally

    3. Subscribe to `CleaningCompleted`:
       ```csharp
       _stateService.CleaningCompleted
           .ObserveOn(RxApp.MainThreadScheduler)
           .Subscribe(OnCleaningCompleted);
       ```
       In `OnCleaningCompleted`:
       - Set `SessionResult = session`
       - Set `IsShowingResults = true`
       - Set `WasCancelled = session.WasCancelled`
       - Calculate `SessionSummaryText` from session
       - Calculate total ITM/UDR/Nav counts from session
       - Set `IsCleaning = false`

    **Reset behavior:** When a new cleaning session starts (detected via `OnStateChanged` when `IsCleaning` transitions to true):
    - Clear `CompletedPlugins`
    - Reset all counters to 0
    - Set `IsShowingResults = false`
    - Set `SessionResult = null`

    **Keep existing:** StopCommand, CloseCommand, CloseRequested event, ProgressText computed property. Ensure they still work.
  </action>
  <verify>
    `dotnet build` succeeds. ProgressViewModel has all new properties. The LogOutput property is removed. Throttled subscription uses Sample(100ms). DetailedPluginResult subscription populates CompletedPlugins collection.
  </verify>
  <done>
    ProgressViewModel tracks per-plugin ITM/UDR/Nav counters, accumulates completed plugin results in an ObservableCollection, transitions to results summary mode via IsShowingResults, uses throttled state subscriptions (Sample 100ms + merge final state), and clears state when a new session starts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Redesign ProgressWindow XAML and add close prevention</name>
  <files>
    AutoQAC/Views/ProgressWindow.axaml
    AutoQAC/Views/ProgressWindow.axaml.cs
  </files>
  <action>
    **ProgressWindow.axaml -- complete redesign:**

    The window has two panels: an "active cleaning" panel and a "results summary" panel. Only one is visible at a time, controlled by `IsShowingResults`.

    **Active Cleaning Panel** (IsVisible="{Binding !IsShowingResults}"):
    1. **Current Plugin section** (top):
       - "Currently cleaning:" label + plugin name in bold/larger font
       - Counter badges in a horizontal StackPanel next to/below the plugin name:
         - ITM badge: green-ish background, "ITM: {CurrentItmCount}"
         - UDR badge: amber/gold background, "UDR: {CurrentUdrCount}"
         - Nav badge: brown-ish background, "Nav: {CurrentNavCount}"
       - Badges only visible when `HasCurrentPluginStats` is true
       - Use Border with CornerRadius=3, Padding=8,3 for each badge. White text, SemiBold label.

    2. **Summary bar** (below current plugin):
       - A Border with subtle background, containing text like:
         "{Progress}/{Total} plugins -- {SkippedCount} skipped, {FailedCount} failed"
       - Use Run elements for data binding within a TextBlock

    3. **Progress bar** (below summary):
       - ProgressBar with Value="{Binding Progress}" Maximum="{Binding Total}" Height=25

    4. **Completed plugins list** (fills remaining space):
       - "Completed:" header
       - ListBox or ItemsControl bound to `CompletedPlugins` (ObservableCollection<PluginCleaningResult>)
       - Each item shows: plugin name, summary (ITM/UDR counts), duration
       - If `HasLogParseWarning` is true, show a warning indicator (e.g., "!" or warning text) with ToolTip showing the LogParseWarning message
       - ScrollViewer wrapping the list so it scrolls as items accumulate

    5. **Stop button** at bottom right (existing, keep)

    **Results Summary Panel** (IsVisible="{Binding IsShowingResults}"):
    1. **Session summary header**:
       - Large text: "Cleaning Complete" or "Cleaning Cancelled" based on WasCancelled
       - SessionSummaryText below it

    2. **Totals grid**:
       - Plugins cleaned / skipped / failed counts
       - Total ITMs removed, UDRs fixed, Navmeshes undeleted
       - Duration

    3. **Per-plugin results list**:
       - Same CompletedPlugins collection, showing all processed plugins with their stats
       - Same item template as the active panel or a slightly more detailed one

    4. **Close button** at bottom right

    Use DynamicResource for theme-aware colors. Keep window size at 600x450 (slightly taller to fit badges). CanResize=False. Set Padding/Margins for clean spacing.

    **ProgressWindow.axaml.cs -- close prevention:**

    Override `OnClosing` to prevent closing while cleaning is in progress:
    ```csharp
    protected override void OnClosing(WindowClosingEventArgs e)
    {
        if (DataContext is ProgressViewModel { IsCleaning: true })
        {
            e.Cancel = true;
            return;
        }
        base.OnClosing(e);
    }
    ```

    Keep the existing OnClosed cleanup (dispose ViewModel when window closes after cleaning is done).
  </action>
  <verify>
    `dotnet build` succeeds. Launch the app (if possible) or verify XAML compiles correctly. The AXAML should reference all ViewModel properties that exist. Check that binding paths match property names in ProgressViewModel exactly.
  </verify>
  <done>
    ProgressWindow.axaml has two panels: active cleaning (counter badges, summary bar, progress bar, completed plugins list with log parse warning icons) and results summary (session totals, per-plugin list). Panels toggle via IsShowingResults binding. Close is prevented during cleaning via OnClosing override. All bindings reference valid ProgressViewModel properties.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` -- project compiles with no errors
2. `dotnet test` -- all tests pass
3. Verify ProgressViewModel subscribes to DetailedPluginResult and CleaningCompleted observables
4. Verify ProgressWindow.axaml has two visibility-toggled panels (active and results)
5. Verify counter badge bindings: CurrentItmCount, CurrentUdrCount, CurrentNavCount
6. Verify summary bar bindings: Progress, Total, SkippedCount, FailedCount
7. Verify close prevention: OnClosing cancels when IsCleaning is true
8. Verify no LogOutput string concatenation remains (anti-pattern removed)
</verification>

<success_criteria>
- Progress window shows live ITM/UDR/Nav counter badges during cleaning (per user decision)
- Compact summary bar shows plugin count and skip/fail counts (per user decision)
- Progress bar fills based on plugins completed (per user decision)
- Completed plugin stats persist and accumulate below current plugin (per user decision)
- Progress window transforms into results summary when cleaning finishes (per user decision)
- Cancel shows partial summary with cancelled indication (per user decision)
- Log parse warnings show inline with tooltip (per user decision)
- StateChanged subscription uses Sample(100ms) for 100+ plugin sessions (STAT-02)
- Window cannot be closed during active cleaning
</success_criteria>

<output>
After completion, create `.planning/phases/03-real-time-feedback/03-02-SUMMARY.md`
</output>
