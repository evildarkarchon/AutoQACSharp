---
phase: 04-configuration-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - AutoQAC/ViewModels/SettingsViewModel.cs
  - AutoQAC/Views/SettingsWindow.axaml
  - AutoQAC/Views/MainWindow.axaml
  - AutoQAC/Services/Configuration/ILogRetentionService.cs
  - AutoQAC/Services/Configuration/LogRetentionService.cs
  - AutoQAC/Infrastructure/ServiceCollectionExtensions.cs
  - AutoQAC/App.axaml.cs
autonomous: false

must_haves:
  truths:
    - "In Settings, xEdit path field shows green border with checkmark when path points to an existing .exe file"
    - "In Settings, xEdit path field shows red border with X icon when path is empty or points to a non-existent file"
    - "Path validation triggers on debounced input (~400ms) after user pauses typing"
    - "Browse button selections validate immediately with no debounce"
    - "All four path fields in Settings are validated: xEdit, MO2, load order, data directory"
    - "Path fields do not show errors when Settings first opens (no red on untouched fields)"
    - "Log retention settings (age-based or count-based) are configurable in Settings"
    - "Old log files are cleaned up on app startup according to the configured retention"
    - "Active Serilog log file is never deleted by retention cleanup"
    - "Migration warning banner appears at top of main window when migration fails"
    - "Migration warning banner is dismissible and persists until dismissed"
  artifacts:
    - path: "AutoQAC/Services/Configuration/ILogRetentionService.cs"
      provides: "Interface for log/journal retention cleanup"
      exports: ["ILogRetentionService"]
    - path: "AutoQAC/Services/Configuration/LogRetentionService.cs"
      provides: "Startup cleanup of old log files by age or count"
      contains: "CleanupAsync"
    - path: "AutoQAC/ViewModels/SettingsViewModel.cs"
      provides: "Path validation properties with debounced Rx observables"
      contains: "Throttle"
    - path: "AutoQAC/Views/SettingsWindow.axaml"
      provides: "Path text fields with validation indicators and retention UI"
      contains: "path-valid"
    - path: "AutoQAC/Views/MainWindow.axaml"
      provides: "Migration warning banner at top of main window"
      contains: "MigrationWarning"
  key_links:
    - from: "AutoQAC/ViewModels/SettingsViewModel.cs"
      to: "File system"
      via: "WhenAnyValue + Throttle(400ms) + File.Exists validation"
      pattern: "Throttle.*400|ValidatePath"
    - from: "AutoQAC/Views/SettingsWindow.axaml"
      to: "AutoQAC/ViewModels/SettingsViewModel.cs"
      via: "Data binding to path validation state properties"
      pattern: "IsXEditPathValid|XEditPathValidation"
    - from: "AutoQAC/App.axaml.cs"
      to: "AutoQAC/Services/Configuration/ILogRetentionService.cs"
      via: "Runs cleanup on startup"
      pattern: "CleanupAsync|ILogRetentionService"
    - from: "AutoQAC/Views/MainWindow.axaml"
      to: "AutoQAC/ViewModels/MainWindowViewModel.cs"
      via: "Binding to HasMigrationWarning and MigrationWarningMessage"
      pattern: "HasMigrationWarning"
---

<objective>
Build the Settings validation UI (CONF-02), log retention service (CONF-07), and migration warning banner UI. This plan adds real-time path validation with red/green visual feedback to all path fields in Settings, a log retention cleanup service that runs on startup, retention settings UI in the Settings window, and the migration warning banner in MainWindow.

Purpose: Users see real-time visual feedback on path validity before starting cleaning, old log files are automatically cleaned up, and migration failures are clearly communicated instead of silently lost.

Output: Extended SettingsViewModel with path validation, styled SettingsWindow with path fields and retention controls, LogRetentionService with startup cleanup, migration banner XAML in MainWindow.
</objective>

<execution_context>
@C:\Users\evild\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\evild\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration-enhancement/04-CONTEXT.md
@.planning/phases/04-configuration-enhancement/04-RESEARCH.md
@.planning/phases/04-configuration-enhancement/04-01-SUMMARY.md
@AutoQAC/ViewModels/SettingsViewModel.cs
@AutoQAC/Views/SettingsWindow.axaml
@AutoQAC/Views/MainWindow.axaml
@AutoQAC/ViewModels/MainWindowViewModel.cs
@AutoQAC/Models/Configuration/UserConfiguration.cs
@AutoQAC/Models/Configuration/RetentionSettings.cs
@AutoQAC/Services/Configuration/IConfigurationService.cs
@AutoQAC/Infrastructure/Logging/LoggingService.cs
@AutoQAC/Infrastructure/ServiceCollectionExtensions.cs
@AutoQAC/App.axaml.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Path validation in SettingsViewModel, log retention service, and Settings UI</name>
  <files>
    AutoQAC/ViewModels/SettingsViewModel.cs
    AutoQAC/Views/SettingsWindow.axaml
    AutoQAC/Services/Configuration/ILogRetentionService.cs
    AutoQAC/Services/Configuration/LogRetentionService.cs
    AutoQAC/Infrastructure/ServiceCollectionExtensions.cs
    AutoQAC/App.axaml.cs
  </files>
  <action>
    **1. Create ILogRetentionService** (`AutoQAC/Services/Configuration/ILogRetentionService.cs`):
    - Interface with `Task CleanupAsync(CancellationToken ct = default)` -- reads retention settings from config, enumerates logs/, deletes old files

    **2. Create LogRetentionService** (`AutoQAC/Services/Configuration/LogRetentionService.cs`):
    - Constructor: inject `IConfigurationService`, `ILoggingService`
    - `CleanupAsync`:
      1. Load user config to get `LogRetention` settings
      2. Define log directory: `logs/` (same as LoggingService)
      3. If directory does not exist, return (no-op)
      4. Enumerate `autoqac-*.log` files, ordered by LastWriteTimeUtc descending
      5. ALWAYS skip the first file (most recent = active Serilog log file). This is CRITICAL to avoid deleting the file Serilog is currently writing to.
      6. If `RetentionMode.AgeBased`: delete files older than `MaxAgeDays` (default 30). Cutoff = `DateTime.UtcNow.AddDays(-settings.MaxAgeDays)`
      7. If `RetentionMode.CountBased`: keep `MaxFileCount` files (default 50), delete the rest (oldest first). Skip(MaxFileCount - 1) since we already skipped the active file.
      8. Log each deletion at Debug level, log summary at Information level ("Cleaned up {count} old log files")
      9. Wrap each File.Delete in try/catch -- log warning on failure, continue with next file (do not abort cleanup for one locked file)
    - Default retention values per Claude's discretion: 30 days / 50 files (matching research recommendation)

    **3. Extend SettingsViewModel with path validation properties**:
    - Add new properties for path values (these are separate from MainWindowViewModel's read-only display paths):
      - `string? XEditPath` with RaiseAndSetIfChanged
      - `string? Mo2Path` with RaiseAndSetIfChanged
      - `string? LoadOrderPath` with RaiseAndSetIfChanged
      - `string? DataFolderPath` with RaiseAndSetIfChanged
    - Add validation state properties (nullable bool: null = untouched, true = valid, false = invalid):
      - `bool? IsXEditPathValid` with RaiseAndSetIfChanged
      - `bool? IsMo2PathValid` with RaiseAndSetIfChanged
      - `bool? IsLoadOrderPathValid` with RaiseAndSetIfChanged
      - `bool? IsDataFolderPathValid` with RaiseAndSetIfChanged
    - Add "touched" tracking to avoid showing errors on initial load (research pitfall 5):
      - Use `Skip(1)` on each WhenAnyValue observable to skip the initial property set during LoadSettingsAsync
      - Or use a `_isLoading` flag that is set true during LoadSettingsAsync, set false after
    - In constructor, set up debounced validation pipelines for each path:
      ```
      this.WhenAnyValue(x => x.XEditPath)
          .Skip(1)  // Skip initial load
          .Throttle(TimeSpan.FromMilliseconds(400))
          .ObserveOn(RxApp.MainThreadScheduler)
          .Select(path => ValidateExecutablePath(path))
          .Subscribe(valid => IsXEditPathValid = valid);
      ```
    - Validation helper methods:
      - `ValidateExecutablePath(string? path)` -> bool: not empty AND File.Exists AND ends with .exe
      - `ValidateFilePath(string? path)` -> bool: not empty AND File.Exists (for load order .txt)
      - `ValidateDirectoryPath(string? path)` -> bool: not empty AND Directory.Exists (for data folder)
      - `ValidateOptionalPath(string? path, Func<string, bool> validator)` -> bool: empty = valid (optional field), non-empty = apply validator
    - Mo2Path validation: use `ValidateOptionalPath` -- empty is valid (MO2 is optional unless Mo2Mode is on)
    - LoadOrderPath validation: use `ValidateOptionalPath` with `ValidateFilePath`
    - DataFolderPath validation: use `ValidateOptionalPath` with `ValidateDirectoryPath`
    - Add browse commands that validate immediately (no debounce, per user decision):
      - `BrowseXEditCommand`, `BrowseMo2Command`, `BrowseLoadOrderCommand`, `BrowseDataFolderCommand`
      - Each opens a file/folder dialog, sets the path property, AND immediately sets the validation property (bypassing the Throttle)
    - In `LoadSettingsAsync`, load path values from config:
      ```
      XEditPath = config.XEdit.Binary;
      Mo2Path = config.ModOrganizer.Binary;
      LoadOrderPath = config.LoadOrder.File;
      // DataFolderPath loaded per selected game (may need game selection context)
      ```
    - Add retention settings properties:
      - `int RetentionMode` (0 = AgeBased, 1 = CountBased -- for ComboBox SelectedIndex binding)
      - `int MaxAgeDays` with RaiseAndSetIfChanged (default 30)
      - `int MaxFileCount` with RaiseAndSetIfChanged (default 50)
    - In `LoadSettingsAsync`, load retention from config.LogRetention
    - In `SaveAsync`, save path values and retention settings back to config
    - Include retention in the "unsaved changes" tracking and validation (MaxAgeDays >= 1, MaxFileCount >= 1)

    **4. Update SettingsWindow XAML** (`AutoQAC/Views/SettingsWindow.axaml`):
    - Increase window height to ~600 to accommodate new sections (from 400)
    - Add a "File Paths" section at the top with four path fields:
      - xEdit Path: TextBox + Browse button + validation indicator
      - MO2 Path: TextBox + Browse button + validation indicator
      - Load Order Path: TextBox + Browse button + validation indicator
      - Data Folder: TextBox + Browse button + validation indicator
    - Each path field row is a Grid with columns: Label (120px), TextBox (*), indicator icon (Auto), Browse button (Auto)
    - Validation indicator: a TextBlock or PathIcon showing checkmark (green) or X (red):
      - IsVisible when validation is not null (field has been touched)
      - Green checkmark: `IsVisible="{Binding IsXEditPathValid}"`, Foreground="#4CAF50", Text or Content of checkmark icon
      - Red X: `IsVisible` bound to negation of IsXEditPathValid (when not null and false)
      - Use a multi-binding or converter, OR simpler: two overlapping indicators with opposing visibility
    - Style the TextBox borders based on validation state:
      - Define styles in the Window's Resources:
        ```xml
        <Style Selector="TextBox.path-valid /template/ Border#PART_BorderElement">
            <Setter Property="BorderBrush" Value="#4CAF50" />
            <Setter Property="BorderThickness" Value="2" />
        </Style>
        <Style Selector="TextBox.path-invalid /template/ Border#PART_BorderElement">
            <Setter Property="BorderBrush" Value="#F44336" />
            <Setter Property="BorderThickness" Value="2" />
        </Style>
        ```
      - Apply classes dynamically via a converter or use Avalonia's `Classes.path-valid` binding pattern. If Avalonia class binding is complex, an alternative approach: bind BorderBrush and BorderThickness directly on a wrapper Border around the TextBox (simpler, avoids template selector issues).
    - Add a "Log Retention" section (after Journal Settings):
      - Retention Mode: ComboBox with options "Age-based (delete after N days)" and "Count-based (keep last N files)"
      - When AgeBased selected: show NumericUpDown for MaxAgeDays (min 1, max 365, default 30)
      - When CountBased selected: show NumericUpDown for MaxFileCount (min 1, max 1000, default 50)
      - Use `IsVisible` binding to show the relevant control based on selected mode

    **5. Register LogRetentionService in DI**:
    - Add `services.AddSingleton<ILogRetentionService, LogRetentionService>()` in `AddConfiguration`

    **6. Wire log retention cleanup on app startup** (`AutoQAC/App.axaml.cs`):
    - After resolving services and calling migration, resolve `ILogRetentionService`
    - Call `CleanupAsync()` fire-and-forget with error handling (log warning on failure, do not block startup)

    CRITICAL PITFALLS TO AVOID:
    - Path validation must NOT show errors before user has interacted (use Skip(1) or _isLoading flag) -- research pitfall 5
    - Retention cleanup must NEVER delete the active Serilog log file (always Skip(1) on the most recent file) -- research pitfall 4
    - Browse button results validate immediately, no debounce (user decision: "deliberate user action")
    - Debounce is 400ms per research recommendation (within user's 300-500ms range)
    - SettingsViewModel needs IFileDialogService injected for browse commands (check existing constructor, add if missing)
  </action>
  <verify>
    `dotnet build` succeeds. `dotnet test` passes.
    Verify SettingsViewModel has path validation properties and Throttle(400ms) pipelines.
    Verify SettingsWindow.axaml has path fields with validation indicators.
    Verify LogRetentionService skips the most recent log file.
    Verify LogRetentionService is called on startup in App.axaml.cs.
  </verify>
  <done>
    All four path fields in Settings show debounced validation with green/red indicators. Browse buttons validate immediately. No errors shown on initial load. Log retention settings are configurable with age-based and count-based modes. LogRetentionService cleans up old logs on startup, never deleting the active log file. Build and tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4 Configuration Enhancement:
    1. Settings window with real-time path validation (red/green borders + icons) for xEdit, MO2, load order, and data folder paths
    2. Debounced validation (400ms) on typing, immediate validation on browse
    3. Log retention settings (age-based / count-based) in Settings
    4. Migration warning banner in MainWindow (only visible if legacy migration fails)
    5. Config watcher that silently reloads when YAML is externally edited
  </what-built>
  <how-to-verify>
    1. Run the application: `dotnet run --project AutoQAC`
    2. Open Settings (Edit > Settings)
    3. Verify path fields section exists with xEdit, MO2, Load Order, Data Folder fields
    4. Type an invalid path in the xEdit field (e.g., "C:\nonexistent\fake.exe") -- after ~400ms pause, field should show red border with X indicator
    5. Browse for a real .exe file -- field should immediately show green border with checkmark
    6. Clear the xEdit field -- should show red (required field)
    7. Verify MO2 field allows empty (optional) -- no red border when empty
    8. Verify Log Retention section exists with mode dropdown and appropriate number inputs
    9. Change retention mode between age-based and count-based -- verify the relevant input shows/hides
    10. Save settings and reopen -- verify retention values persist
    11. Close Settings and check MainWindow -- no migration warning banner should be visible (unless you have a legacy AutoQAC Config.yaml file to test with)
    12. Verify no path fields show errors when Settings first opens (all should be neutral until touched)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build` compiles with zero errors
2. `dotnet test` -- all existing tests pass (no regressions)
3. Path validation uses Throttle(400ms) -- grep for "Throttle" in SettingsViewModel.cs
4. Path validation uses Skip(1) or equivalent to avoid errors on initial load
5. LogRetentionService always skips the most recent log file -- grep for "Skip(1)" or equivalent
6. SettingsWindow.axaml has path-valid and path-invalid styles
7. MainWindow.axaml has migration warning banner with HasMigrationWarning binding
8. LogRetentionService is called on startup in App.axaml.cs
</verification>

<success_criteria>
- All four path fields show real-time validation feedback (red border + X for invalid, green border + checkmark for valid)
- Validation triggers after 400ms debounce on typing
- Browse button results validate immediately
- Path fields do not show errors on initial Settings open
- Log retention settings (age-based days OR count-based count) are available in Settings
- Old log files are cleaned up on app startup per retention settings
- Active Serilog log file is never deleted
- Migration warning banner appears at top of MainWindow when migration fails
- Migration warning banner is dismissible
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration-enhancement/04-02-SUMMARY.md`
</output>
