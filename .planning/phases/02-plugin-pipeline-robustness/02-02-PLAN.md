---
phase: 02-plugin-pipeline-robustness
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - AutoQAC/Models/GameVariant.cs
  - AutoQAC/Services/GameDetection/IGameDetectionService.cs
  - AutoQAC/Services/GameDetection/GameDetectionService.cs
  - AutoQAC/Services/Configuration/ConfigurationService.cs
  - AutoQAC/Services/Cleaning/XEditCommandBuilder.cs
  - AutoQAC/Services/Cleaning/CleaningOrchestrator.cs
  - AutoQAC.Tests/Services/GameDetectionServiceTests.cs
  - AutoQAC.Tests/Services/XEditCommandBuilderTests.cs
  - AutoQAC.Tests/Services/CleaningOrchestratorTests.cs
  - AutoQAC.Tests/Services/ConfigurationServiceSkipListTests.cs
  - AutoQAC.Tests/Services/MO2ValidationServiceTests.cs
autonomous: true

must_haves:
  truths:
    - "TTW users see FO3 skip list entries automatically merged into FNV skip list when TaleOfTwoWastelands.esm is detected in the load order"
    - "Enderal users get a separate Enderal skip list when Enderal - Forgotten Stories.esm is detected in the load order"
    - "Attempting to clean with GameType.Unknown blocks completely with a clear error message"
    - "XEditCommandBuilder rejects GameType.Unknown and returns null instead of silently producing a command with empty game flag"
    - "Multiple plugin path failures are reported as an aggregated summary, not one-per-plugin"
    - "MO2 mode active: file-existence/readability validation is skipped for individual plugins because MO2's VFS handles path resolution at xEdit runtime"
    - "MO2 configuration errors include actionable fix guidance (e.g., 'Check MO2 profile path in Settings')"
  artifacts:
    - path: "AutoQAC/Models/GameVariant.cs"
      provides: "GameVariant enum (None, TTW, Enderal)"
    - path: "AutoQAC/Services/GameDetection/GameDetectionService.cs"
      provides: "DetectVariant method scanning load order for marker plugins"
      contains: "TaleOfTwoWastelands.esm"
    - path: "AutoQAC/Services/Configuration/ConfigurationService.cs"
      provides: "TTW skip list merge in GetSkipListAsync"
      contains: "GameVariant.TTW"
    - path: "AutoQAC/Services/Cleaning/CleaningOrchestrator.cs"
      provides: "Unknown game type blocking, aggregated path error reporting, MO2 mode validation skip"
      contains: "GameType.Unknown"
  key_links:
    - from: "AutoQAC/Services/Cleaning/CleaningOrchestrator.cs"
      to: "AutoQAC/Services/GameDetection/GameDetectionService.cs"
      via: "DetectVariant call after game type detection"
      pattern: "DetectVariant"
    - from: "AutoQAC/Services/Configuration/ConfigurationService.cs"
      to: "AutoQAC/Services/GameDetection/IGameDetectionService.cs"
      via: "GameVariant used in GetSkipListAsync to trigger FO3 merge"
      pattern: "GameVariant"
    - from: "AutoQAC/Services/Cleaning/XEditCommandBuilder.cs"
      to: "AutoQAC/Models/GameType.cs"
      via: "GameType.Unknown rejection before building command"
      pattern: "GameType.Unknown"
    - from: "AutoQAC/Services/Cleaning/CleaningOrchestrator.cs"
      to: "AutoQAC/Models/Configuration/UserConfiguration.cs"
      via: "Mo2Mode check to skip file validation"
      pattern: "Mo2Mode"
---

<objective>
Add game variant detection (TTW and Enderal), wire skip list inheritance for TTW and separate skip list for Enderal, block cleaning on GameType.Unknown, add aggregated path-failure error reporting, and handle MO2 mode by skipping file-existence validation (MO2's VFS resolves paths at xEdit runtime) with actionable error messages for invalid MO2 configuration.

Purpose: PLUG-04 (TTW skip list inheritance), PLUG-05 (GameType.Unknown rejection in XEditCommandBuilder), GAME-01 (game detection fallback validation), and MO2 path resolution are safety-critical -- cleaning without proper skip lists risks corrupting base game plugins, and MO2 users cannot have their plugins validated against the real filesystem.

Output: Game variant detection wired through to skip list loading, Unknown game type blocking in orchestrator and command builder, aggregated error reporting for missing plugins, MO2 mode skips file validation with actionable MO2 error messages.
</objective>

<execution_context>
@C:\Users\evild\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\evild\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plugin-pipeline-robustness/02-RESEARCH.md
@.planning/phases/02-plugin-pipeline-robustness/02-01-SUMMARY.md

Key files to read before starting:
@AutoQAC/Models/GameType.cs
@AutoQAC/Models/Configuration/UserConfiguration.cs
@AutoQAC/Services/GameDetection/IGameDetectionService.cs
@AutoQAC/Services/GameDetection/GameDetectionService.cs
@AutoQAC/Services/Configuration/IConfigurationService.cs
@AutoQAC/Services/Configuration/ConfigurationService.cs
@AutoQAC/Services/Cleaning/XEditCommandBuilder.cs
@AutoQAC/Services/Cleaning/CleaningOrchestrator.cs
@AutoQAC/Services/Cleaning/ICleaningOrchestrator.cs
@AutoQAC/Services/MO2/IMO2ValidationService.cs
@AutoQAC/Services/MO2/MO2ValidationService.cs
@AutoQAC.Tests/Services/GameDetectionServiceTests.cs
@AutoQAC.Tests/Services/XEditCommandBuilderTests.cs
@AutoQAC.Tests/Services/CleaningOrchestratorTests.cs
@AutoQAC.Tests/Services/ConfigurationServiceSkipListTests.cs
@AutoQAC.Tests/Services/MO2ValidationServiceTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for game variant detection, skip list merge, and Unknown rejection</name>
  <files>
    AutoQAC/Models/GameVariant.cs
    AutoQAC/Services/GameDetection/IGameDetectionService.cs
    AutoQAC.Tests/Services/GameDetectionServiceTests.cs
    AutoQAC.Tests/Services/XEditCommandBuilderTests.cs
    AutoQAC.Tests/Services/CleaningOrchestratorTests.cs
    AutoQAC.Tests/Services/ConfigurationServiceSkipListTests.cs
    AutoQAC.Tests/Services/MO2ValidationServiceTests.cs
  </files>
  <action>
**Step 1: Create GameVariant enum**

Create a new file `AutoQAC/Models/GameVariant.cs`:

```csharp
namespace AutoQAC.Models;

/// <summary>
/// Represents a game variant that requires special skip list handling.
/// </summary>
public enum GameVariant
{
    /// <summary>No special variant detected.</summary>
    None,

    /// <summary>Tale of Two Wastelands -- FNV with FO3 content merged in.</summary>
    TTW,

    /// <summary>Enderal -- Total conversion mod for Skyrim SE.</summary>
    Enderal
}
```

**Step 2: Add DetectVariant to IGameDetectionService**

Add the method to the interface:

```csharp
/// <summary>
/// Detect game variant (TTW, Enderal) by scanning the load order for marker plugins.
/// </summary>
GameVariant DetectVariant(GameType baseGame, IReadOnlyList<string> pluginNames);
```

**Step 3: Write failing tests for GameDetectionService.DetectVariant**

Add to `GameDetectionServiceTests.cs`:

1. **TTW detection**: Base game = FalloutNewVegas, pluginNames contains "TaleOfTwoWastelands.esm" -> returns `GameVariant.TTW`
2. **TTW case-insensitive**: Base game = FalloutNewVegas, pluginNames contains "taleoftwowastelands.esm" -> returns `GameVariant.TTW`
3. **TTW wrong base game**: Base game = Fallout3, pluginNames contains "TaleOfTwoWastelands.esm" -> returns `GameVariant.None` (TTW only applies when base game is FNV)
4. **Enderal detection**: Base game = SkyrimSe, pluginNames contains "Enderal - Forgotten Stories.esm" -> returns `GameVariant.Enderal`
5. **Enderal wrong base game**: Base game = Fallout4, pluginNames contains "Enderal - Forgotten Stories.esm" -> returns `GameVariant.None`
6. **No variant**: Base game = SkyrimSe, pluginNames contains "Skyrim.esm", "Update.esm", "Mod.esp" -> returns `GameVariant.None`
7. **Empty load order**: Base game = FalloutNewVegas, empty list -> returns `GameVariant.None`

**Step 4: Write failing tests for XEditCommandBuilder Unknown rejection**

Add to `XEditCommandBuilderTests.cs`:

1. **Unknown game type returns null**: Call `BuildCommand(plugin, GameType.Unknown)` with valid state. Must return `null`.

**Step 5: Write failing tests for CleaningOrchestrator Unknown blocking**

Add to `CleaningOrchestratorTests.cs`:

1. **Unknown game type blocks cleaning**: Set up orchestrator where game detection returns Unknown (both from executable and load order). Call `StartCleaningAsync`. It should throw `InvalidOperationException` with message containing "Unknown" or "game type".

**Step 6: Write failing tests for TTW skip list merge**

Add to `ConfigurationServiceSkipListTests.cs` (or create new test class if needed):

1. **TTW skip list includes FO3 entries**: When getting skip list for FNV with variant TTW, the result includes both FNV-specific entries AND FO3-specific entries from Main.yaml.
2. **Non-TTW FNV does NOT include FO3**: When getting skip list for FNV without TTW variant, FO3 entries are NOT included.
3. **Enderal uses separate skip list**: When getting skip list for SkyrimSe with variant Enderal, the result uses Enderal-specific entries (key "Enderal"), not SSE entries.

Note: The skip list tests will likely require updating `GetSkipListAsync` to accept a variant parameter, or the variant must be stored somewhere accessible. Per Claude's discretion, use a parameter approach: add `GameVariant variant = GameVariant.None` parameter to `GetSkipListAsync` in the interface.

**Step 7: Write failing tests for MO2 mode file validation skip and MO2 error guidance**

Add to `CleaningOrchestratorTests.cs`:

1. **MO2 mode skips file-existence validation**: Set up orchestrator with `Mo2Mode = true` in config. Mock `ValidatePluginFile` to return `PluginWarningKind.NotFound` for all plugins. Call `StartCleaningAsync`. The orchestrator should NOT remove any plugins from the cleaning list (it should skip the validation entirely). Verify `ValidatePluginFile` is never called when MO2 mode is active.

2. **MO2 mode off runs file validation normally**: Set up orchestrator with `Mo2Mode = false`. Mock `ValidatePluginFile` to return `NotFound` for one plugin and `None` for others. The failing plugin should be removed from the list and an aggregated warning logged.

3. **MO2 mode with invalid MO2 binary path**: Set up orchestrator with `Mo2Mode = true` but `Mo2ExecutablePath` is null or empty. The error message should contain actionable guidance mentioning "MO2" and "Settings" (e.g., "Check MO2 executable path in Settings").

4. **MO2 mode with non-existent MO2 binary**: Set up orchestrator with `Mo2Mode = true` and `Mo2ExecutablePath = "C:\\nonexistent\\ModOrganizer.exe"`. The error message should contain actionable guidance (e.g., "MO2 executable not found at ... Check MO2 path in Settings").

Run `dotnet test` and confirm all new tests fail.
  </action>
  <verify>
    `dotnet test` shows compilation errors or test failures for all new tests. Existing tests still pass (no interface changes to existing method signatures yet -- the new DetectVariant is additive).
  </verify>
  <done>
    Test suite captures all behaviors for PLUG-04 (TTW), PLUG-05 (Unknown rejection), GAME-01 (Unknown blocking), and MO2 mode handling (validation skip, actionable error messages). New GameVariant enum exists. Tests are RED.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement variant detection, skip list merge, Unknown blocking, and aggregated errors</name>
  <files>
    AutoQAC/Services/GameDetection/GameDetectionService.cs
    AutoQAC/Services/Configuration/IConfigurationService.cs
    AutoQAC/Services/Configuration/ConfigurationService.cs
    AutoQAC/Services/Cleaning/XEditCommandBuilder.cs
    AutoQAC/Services/Cleaning/CleaningOrchestrator.cs
    AutoQAC.Tests/Services/GameDetectionServiceTests.cs
    AutoQAC.Tests/Services/XEditCommandBuilderTests.cs
    AutoQAC.Tests/Services/CleaningOrchestratorTests.cs
    AutoQAC.Tests/Services/ConfigurationServiceSkipListTests.cs
  </files>
  <action>
**Step 1: Implement GameDetectionService.DetectVariant**

Add to `GameDetectionService.cs`:

```csharp
public GameVariant DetectVariant(GameType baseGame, IReadOnlyList<string> pluginNames)
{
    if (pluginNames == null || pluginNames.Count == 0)
        return GameVariant.None;

    if (baseGame == GameType.FalloutNewVegas)
    {
        if (pluginNames.Any(p => p.Equals("TaleOfTwoWastelands.esm", StringComparison.OrdinalIgnoreCase)))
        {
            _logger.Information("Detected TTW (Tale of Two Wastelands) variant");
            return GameVariant.TTW;
        }
    }

    if (baseGame == GameType.SkyrimSe)
    {
        if (pluginNames.Any(p =>
            p.Equals("Enderal - Forgotten Stories.esm", StringComparison.OrdinalIgnoreCase) ||
            p.Equals("Enderal.esm", StringComparison.OrdinalIgnoreCase)))
        {
            _logger.Information("Detected Enderal variant");
            return GameVariant.Enderal;
        }
    }

    return GameVariant.None;
}
```

**Step 2: Update GetSkipListAsync for variant-aware skip list loading**

Update the `IConfigurationService.GetSkipListAsync` signature to:

```csharp
Task<List<string>> GetSkipListAsync(GameType gameType, GameVariant variant = GameVariant.None);
```

In `ConfigurationService.GetSkipListAsync`, add TTW merge logic:

```csharp
public async Task<List<string>> GetSkipListAsync(GameType gameType, GameVariant variant = GameVariant.None)
{
    _mainConfigCache ??= await LoadMainConfigAsync().ConfigureAwait(false);
    var userConfig = await LoadUserConfigAsync().ConfigureAwait(false);

    var result = new List<string>();

    // For Enderal, use Enderal-specific key instead of SSE
    var key = variant == GameVariant.Enderal ? "Enderal" : GetGameKey(gameType);

    // 1. User's game-specific skip list
    if (userConfig.SkipLists.TryGetValue(key, out var userList))
        result.AddRange(userList);

    // 2. Game-specific skip list from Main.yaml
    if (_mainConfigCache.Data.SkipLists.TryGetValue(key, out var mainGameList))
        result.AddRange(mainGameList);

    // 3. TTW: also merge FO3 skip list entries (per user decision: silently, no prompt, no log noise)
    if (variant == GameVariant.TTW)
    {
        var fo3Key = GetGameKey(GameType.Fallout3);
        if (userConfig.SkipLists.TryGetValue(fo3Key, out var userFo3List))
            result.AddRange(userFo3List);
        if (_mainConfigCache.Data.SkipLists.TryGetValue(fo3Key, out var mainFo3List))
            result.AddRange(mainFo3List);
    }

    // 4. Universal from Main.yaml
    if (_mainConfigCache.Data.SkipLists.TryGetValue("Universal", out var universalList))
        result.AddRange(universalList);

    return result.Distinct(StringComparer.OrdinalIgnoreCase).ToList();
}
```

CRITICAL: After updating `IConfigurationService.GetSkipListAsync`, grep ALL test files for `GetSkipListAsync` and update every Moq Setup/Verify call to include the new `GameVariant` parameter matcher (use `It.IsAny<GameVariant>()` for backward-compatible mocks).

**Step 3: Reject GameType.Unknown in XEditCommandBuilder**

At the top of `BuildCommand`, add:

```csharp
if (gameType == GameType.Unknown)
{
    return null; // Cannot build command without known game type
}
```

**Step 4: Block GameType.Unknown in CleaningOrchestrator.StartCleaningAsync**

After the game detection block (step 3 in the orchestrator), replace the current fallback:

```csharp
// Current code (REPLACE):
// else
// {
//     _logger.Warning("Could not auto-detect game type. Skip list might be empty.");
// }

// New code:
else
{
    _logger.Error(null, "Cannot determine game type. Cleaning blocked for safety -- skip lists cannot be applied without a known game type.");
    throw new InvalidOperationException(
        "Cannot start cleaning: game type could not be determined. " +
        "Please select a game type in Settings, or ensure the xEdit executable name matches a supported game.");
}
```

This ensures GameType.Unknown never reaches the cleaning loop.

**Step 5: Wire variant detection into the orchestrator**

After game type is resolved (and it is NOT Unknown), detect the variant:

```csharp
gameType = config.CurrentGameType;

// Detect game variant for skip list handling
var pluginNames = allPlugins.Select(p => p.FileName).ToList();
var gameVariant = _gameDetectionService.DetectVariant(gameType, pluginNames);
if (gameVariant != GameVariant.None)
{
    _logger.Information("Detected game variant: {Variant}", gameVariant);
}
```

Then pass `gameVariant` to `GetSkipListAsync`:

```csharp
var skipList = await _configService.GetSkipListAsync(gameType, gameVariant).ConfigureAwait(false) ?? [];
```

**Step 6: Add aggregated path-failure error reporting with MO2 mode bypass**

After the skip list filtering step in the orchestrator, before `_stateService.StartCleaning(pluginsToClean)`, add validation using the new `ValidatePluginFile` method from Plan 02-01. **CRITICAL:** When MO2 mode is active, skip file-existence/readability validation entirely because MO2's virtual filesystem handles path resolution at xEdit runtime -- the real file locations are only known to MO2's VFS. Per user decision and research finding in 02-RESEARCH.md.

Read the MO2 mode flag from config (already available as `config.Settings.Mo2Mode` via `UserConfiguration`):

```csharp
var isMo2Mode = config.Settings.Mo2Mode;

// When MO2 mode is active, skip file-existence validation entirely.
// MO2's virtual filesystem resolves plugin paths at xEdit runtime --
// the real file locations are only known to MO2's VFS layer.
if (!isMo2Mode)
{
    // Validate plugin files exist and are readable (before cleaning loop)
    var pathFailures = new List<string>();
    foreach (var plugin in pluginsToClean)
    {
        var warning = _pluginService.ValidatePluginFile(plugin);
        if (warning != PluginWarningKind.None)
        {
            pathFailures.Add($"{plugin.FileName} ({warning})");
        }
    }

    if (pathFailures.Count > 0)
    {
        var summary = $"{pathFailures.Count} plugin(s) not found or unreadable: {string.Join(", ", pathFailures)}";
        _logger.Warning(summary);

        // Remove unfound plugins from the cleaning list (warn and skip per user decision)
        pluginsToClean = pluginsToClean
            .Where(p => _pluginService.ValidatePluginFile(p) == PluginWarningKind.None)
            .ToList();

        if (pluginsToClean.Count == 0)
        {
            throw new InvalidOperationException(
                $"No valid plugins to clean. {summary}");
        }
    }
}
else
{
    _logger.Debug("MO2 mode active -- skipping file-existence validation (MO2 VFS resolves paths at xEdit runtime)");
}
```

Note: This calls ValidatePluginFile twice for each plugin when NOT in MO2 mode (once for counting, once for filtering). Optimize by caching the result if performance is a concern, but for correctness-first the double call is fine.

**Step 6b: Add MO2 configuration validation with actionable error messages**

When MO2 mode is active, validate the MO2 binary path EARLY in StartCleaningAsync (before any cleaning work). If the MO2 binary path is missing, empty, or points to a non-existent file, throw with actionable guidance per user decision ("MO2 errors: include actionable fix guidance in error messages"):

```csharp
if (isMo2Mode)
{
    var mo2Path = config.Mo2ExecutablePath; // from UserConfiguration.ModOrganizer.Binary

    if (string.IsNullOrEmpty(mo2Path))
    {
        throw new InvalidOperationException(
            "MO2 mode is enabled but no MO2 executable path is configured. " +
            "Check MO2 executable path in Settings, or disable MO2 mode if not using Mod Organizer 2.");
    }

    if (!File.Exists(mo2Path))
    {
        throw new InvalidOperationException(
            $"MO2 mode is enabled but MO2 executable not found at '{mo2Path}'. " +
            "Check MO2 executable path in Settings, or disable MO2 mode if not using Mod Organizer 2.");
    }
}
```

Place this validation early in `StartCleaningAsync`, after loading config but before loading plugins. This ensures MO2 errors surface immediately with clear guidance rather than failing deep in the cleaning pipeline.

**Step 7: Update all affected mock setups**

CRITICAL: Grep the entire test project for:
- `GetSkipListAsync` -- update all Setup/Verify to include `It.IsAny<GameVariant>()` parameter
- `DetectVariant` -- may need new mock setups in orchestrator tests
- `ValidatePluginFile` -- may need new mock setups in orchestrator tests (was `ValidatePluginExists`, changed in Plan 02-01)

**Step 8: Run all tests**

Run `dotnet test` and verify all tests pass (new and existing).
  </action>
  <verify>
    `dotnet test` passes with 0 failures. All new variant detection tests are GREEN. All existing tests pass.
  </verify>
  <done>
    TTW detection merges FO3 skip list into FNV silently. Enderal detection uses separate Enderal skip list. GameType.Unknown is rejected in both XEditCommandBuilder (returns null) and CleaningOrchestrator (throws with clear message). Multiple path failures are aggregated into a single summary warning. MO2 mode skips file-existence validation (VFS resolves paths at runtime). MO2 config errors include actionable guidance referencing Settings. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds with no warnings related to changed files
2. `dotnet test` passes all tests (new and existing)
3. Verify `GameDetectionService.DetectVariant` exists and is called from CleaningOrchestrator
4. Verify `ConfigurationService.GetSkipListAsync` merges FO3 entries when variant is TTW
5. Verify `XEditCommandBuilder.BuildCommand` returns null for GameType.Unknown
6. Verify `CleaningOrchestrator.StartCleaningAsync` throws InvalidOperationException for Unknown game type
7. Verify aggregated path failure reporting logs a single summary line, not one per plugin
8. Verify no test file references `GetSkipListAsync` without accounting for the GameVariant parameter
9. Verify `CleaningOrchestrator.StartCleaningAsync` does NOT call `ValidatePluginFile` when `Mo2Mode = true`
10. Verify MO2 mode with missing/invalid MO2 binary path throws with message containing "Settings" and "MO2"
</verification>

<success_criteria>
- TTW users get FO3 skip list entries merged into FNV list automatically when TaleOfTwoWastelands.esm is detected
- Enderal users get Enderal-specific skip list entries when Enderal - Forgotten Stories.esm is detected
- GameType.Unknown blocks cleaning with a clear error message pointing to Settings
- XEditCommandBuilder rejects Unknown game type (returns null)
- Multiple path failures produce a single aggregated summary message
- MO2 mode active: file-existence/readability validation is skipped (MO2 VFS resolves paths at xEdit runtime)
- MO2 configuration errors (missing/invalid binary path) produce actionable error messages referencing Settings
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/02-plugin-pipeline-robustness/02-02-SUMMARY.md`
</output>
