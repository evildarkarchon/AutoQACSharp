---
phase: 07-hardening-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - AutoQAC.Tests/Services/BackupServiceTests.cs
  - AutoQAC.Tests/Services/LogRetentionServiceTests.cs
  - AutoQAC.Tests/Services/XEditLogFileServiceTests.cs
  - AutoQAC/AutoQAC.csproj
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "BackupService has tests covering plugin backup success, invalid path, missing source, restore, session metadata, session enumeration, and cleanup old sessions"
    - "LogRetentionService has tests covering age-based deletion, count-based deletion, empty directory, active log file protection, and configuration loading"
    - "XEditLogFileService has tests covering log path computation, stale log detection, missing log file, and successful read"
    - "Mutagen packages are updated to 0.53.x and the project builds without errors"
    - "Code_To_Port/ directory is deleted from the repository"
    - "CLAUDE.md no longer contains Code_To_Port/ references, porting guidelines, or translation tables"
    - "dotnet test passes with 0 failures after all changes"
    - ".NET target framework is verified as net10.0 (latest stable) with confirmed Avalonia/ReactiveUI support"
  artifacts:
    - path: "AutoQAC.Tests/Services/BackupServiceTests.cs"
      provides: "BackupService unit tests"
      min_lines: 150
    - path: "AutoQAC.Tests/Services/LogRetentionServiceTests.cs"
      provides: "LogRetentionService unit tests"
      min_lines: 80
    - path: "AutoQAC.Tests/Services/XEditLogFileServiceTests.cs"
      provides: "XEditLogFileService unit tests"
      min_lines: 60
  key_links:
    - from: "AutoQAC.Tests/Services/BackupServiceTests.cs"
      to: "AutoQAC/Services/Backup/BackupService.cs"
      via: "Tests use temp directories for file system isolation (injectable paths via constructor/method params)"
      pattern: "BackupService|BackupPlugin|RestorePlugin"
    - from: "AutoQAC.Tests/Services/LogRetentionServiceTests.cs"
      to: "AutoQAC/Services/Configuration/LogRetentionService.cs"
      via: "Tests mock IConfigurationService and use temp log directories"
      pattern: "LogRetentionService|CleanupAsync"
    - from: "AutoQAC.Tests/Services/XEditLogFileServiceTests.cs"
      to: "AutoQAC/Services/Cleaning/XEditLogFileService.cs"
      via: "Tests use temp files for log file read operations"
      pattern: "XEditLogFileService|GetLogFilePath|ReadLogFileAsync"
---

<objective>
Add comprehensive test coverage for phase 1-6 features (TEST-06), update Mutagen dependencies to latest stable (DEP-01, DEP-02), verify .NET framework target, and remove Code_To_Port/ reference directory with CLAUDE.md cleanup (POST-01).

Purpose: Three services added in phases 3-5 (XEditLogFileService, LogRetentionService, BackupService) have zero dedicated test files despite being critical path code. Mutagen 0.52.0 has an update to 0.53.1. The Code_To_Port/ reference directory is no longer needed since C# implementation has full feature parity plus enhancements.

Output: 3 new test files, updated Mutagen packages, verified .NET framework, Code_To_Port/ removed from repo, CLAUDE.md cleaned of porting references.
</objective>

<execution_context>
@C:\Users\evild\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\evild\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hardening-cleanup/07-CONTEXT.md
@.planning/phases/07-hardening-cleanup/07-RESEARCH.md
@.planning/phases/07-hardening-cleanup/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: BackupService, LogRetentionService, and XEditLogFileService test coverage</name>
  <files>
    AutoQAC.Tests/Services/BackupServiceTests.cs
    AutoQAC.Tests/Services/LogRetentionServiceTests.cs
    AutoQAC.Tests/Services/XEditLogFileServiceTests.cs
  </files>
  <action>
IMPORTANT: Before writing ANY test, read the full implementation of each service AND its interface to verify exact API signatures, constructor parameters, and return types. Also read the model files they depend on (BackupResult, BackupSession, BackupPluginEntry, PluginInfo, RetentionSettings, RetentionMode, UserConfiguration).

NOTE ON FILE I/O IN TESTS: Per CONTEXT.md, the user decision is "Unit tests only (with mocks/stubs) -- no integration tests with real file I/O or process spawning." The intent is to avoid tests that depend on real application data directories, external services, or production file locations. Using temp directories for services with injectable/configurable paths is standard C# unit test practice for test fixture isolation and is acceptable. BackupService accepts paths via method parameters. XEditLogFileService operates on paths passed to its methods. For LogRetentionService, check if the log directory path is injectable -- if it uses a hardcoded relative path, consider adding a constructor parameter for testability, or test through the public API with temp dirs if the path is relative to CWD.

**Step 1: BackupService tests**

Create NEW file: AutoQAC.Tests/Services/BackupServiceTests.cs

BackupService constructor takes `ILoggingService` (use Mock.Of<ILoggingService>()). File paths are passed via method parameters (injectable), making temp directory usage standard unit testing practice. Implement IDisposable for cleanup.

Test cases:

1. **CreateSessionDirectory_CreatesTimestampedDirectory** -- Call CreateSessionDirectory with a temp backup root. Verify a subdirectory was created matching yyyy-MM-dd_HH-mm-ss pattern.

2. **BackupPlugin_ValidPlugin_CopiesFileSuccessfully** -- Create a temp file, create a PluginInfo with that file as FullPath. Call BackupPlugin. Assert Success=true, FileSizeBytes > 0. Verify the file exists in the session directory.

3. **BackupPlugin_NonRootedPath_ReturnsFailure** -- PluginInfo with FullPath = "relative/path.esp". Assert Success=false, Error contains "not a valid rooted path".

4. **BackupPlugin_EmptyPath_ReturnsFailure** -- PluginInfo with FullPath = "" (empty string). Assert Success=false.

5. **BackupPlugin_MissingSourceFile_ReturnsFailure** -- PluginInfo with FullPath pointing to non-existent absolute path. Assert Success=false, Error contains "does not exist".

6. **BackupPlugin_OverwriteFalse_FailsOnDuplicate** -- Back up same plugin twice to same session dir. Second call should fail (File.Copy with overwrite:false throws IOException). Assert Success=false for second call.

7. **WriteSessionMetadataAsync_WritesValidJson** -- Create a BackupSession, call WriteSessionMetadataAsync. Read back the session.json file and verify it deserializes correctly.

8. **GetBackupSessionsAsync_ReturnsSessionsNewestFirst** -- Create two session directories with session.json files (with different timestamps). Call GetBackupSessionsAsync. Verify returned in reverse chronological order.

9. **GetBackupSessionsAsync_SkipsDirectoriesWithoutMetadata** -- Create a directory without session.json alongside one with. Verify only the one with metadata is returned.

10. **GetBackupSessionsAsync_NonexistentRoot_ReturnsEmpty** -- Call with a path that doesn't exist. Assert empty list.

11. **RestorePlugin_CopiesBackToOriginalPath** -- Set up a backup file in session dir and a BackupPluginEntry. Call RestorePlugin. Verify the file was copied to OriginalPath.

12. **RestorePlugin_MissingBackupFile_ThrowsFileNotFoundException** -- Call RestorePlugin with entry pointing to nonexistent backup file. Assert FileNotFoundException.

13. **CleanupOldSessions_DeletesOldestBeyondMax** -- Create 5 session directories. Call CleanupOldSessions with maxSessionCount=3. Verify only 3 remain (the 3 newest).

14. **CleanupOldSessions_ProtectsCurrentSession** -- Create 3 session directories. Call CleanupOldSessions with maxSessionCount=1 and currentSessionDir pointing to the oldest. Verify the oldest is kept (protected) and only the middle one is deleted (newest is also kept as within count).

15. **GetBackupRoot_ReturnsParentSiblingDirectory** -- Call GetBackupRoot("C:\\Games\\Skyrim\\Data"). Assert returns "C:\\Games\\Skyrim\\AutoQAC Backups".

**Step 2: LogRetentionService tests**

Create NEW file: AutoQAC.Tests/Services/LogRetentionServiceTests.cs

LogRetentionService constructor takes `IConfigurationService` and `ILoggingService`. It uses a hardcoded "logs" directory path (relative to working directory).

IMPORTANT: Read the implementation carefully. If the service uses `Directory.Exists("logs")` and `Directory.GetFiles("logs", "autoqac-*.log")` with a hardcoded relative path, the tests need to work with the CWD-relative "logs" subfolder. Since tests run from the test project output directory, create a "logs" subdirectory there, populate with test files, run the test, then clean up. Use IDisposable for cleanup and unique filenames to avoid test parallelism collisions.

If the log directory path is injectable (constructor parameter or configurable), use temp directory injection instead.

Test cases (mock IConfigurationService to return configured RetentionSettings):

1. **CleanupAsync_NoLogDirectory_DoesNothing** -- Ensure "logs" directory doesn't exist. Call CleanupAsync. Verify no errors (should return early).

2. **CleanupAsync_AgeBased_DeletesOldFiles** -- Create "logs" directory with 5 files: 1 recent, 4 with old LastWriteTimeUtc (set via FileInfo). Mock config with AgeBased mode, MaxAgeDays=7. Call CleanupAsync. Verify old files deleted, recent file and active (newest) file kept.

3. **CleanupAsync_CountBased_KeepsMaxCount** -- Create "logs" directory with 6 files with varying dates. Mock config with CountBased mode, MaxFileCount=3. Call CleanupAsync. Verify only 3 files remain (the 3 newest).

4. **CleanupAsync_AlwaysKeepsNewestFile** -- Create "logs" directory with 2 files, both older than retention cutoff. Mock AgeBased with MaxAgeDays=1. Call CleanupAsync. Verify the newest file (active Serilog log) is kept even though it's old.

5. **CleanupAsync_SingleFile_DoesNothing** -- Create "logs" with 1 file. Call CleanupAsync. Verify file is kept.

6. **CleanupAsync_ConfigError_LogsWarning** -- Mock IConfigurationService.LoadUserConfigAsync to throw. Verify CleanupAsync doesn't throw (catches exception and logs warning).

**Step 3: XEditLogFileService tests**

Create NEW file: AutoQAC.Tests/Services/XEditLogFileServiceTests.cs

XEditLogFileService constructor takes `ILoggingService`. Methods accept paths as parameters (injectable), making temp directory usage standard unit testing practice.

Test cases:

1. **GetLogFilePath_ReturnsCorrectPath** -- Pass "C:\\xEdit\\SSEEdit.exe". Assert returns "C:\\xEdit\\SSEEDIT_log.txt".

2. **GetLogFilePath_HandlesLowerCase** -- Pass "C:\\tools\\xedit.exe". Assert returns "C:\\tools\\XEDIT_log.txt".

3. **GetLogFilePath_InvalidPath_Throws** -- Pass empty string or null. Assert ArgumentException.

4. **ReadLogFileAsync_FileNotFound_ReturnsError** -- Pass path to nonexistent xEdit exe. Assert lines is empty, error contains "not found".

5. **ReadLogFileAsync_StaleLogFile_ReturnsError** -- Create a log file with LastWriteTimeUtc before processStartTime. Call ReadLogFileAsync with processStartTime after the file's modification time. Assert error contains "stale".

6. **ReadLogFileAsync_FreshLogFile_ReturnsLines** -- Create a temp directory, create a log file named "{STEM}_log.txt" with known content, set its LastWriteTimeUtc to after a test processStartTime. Call ReadLogFileAsync. Assert lines contain expected content, error is null.

7. **ReadLogFileAsync_Cancellation_ThrowsOperationCancelled** -- Pass an already-cancelled CancellationToken. Assert OperationCanceledException is thrown (from File.ReadAllLinesAsync).

Note: For tests 5-6, create a temp directory structure matching what GetLogFilePath expects. E.g., create temp/SSEEdit.exe (empty file) and temp/SSEEDIT_log.txt (with content), then call ReadLogFileAsync with the exe path.
  </action>
  <verify>
Run `dotnet test AutoQAC.Tests` -- all tests pass. Verify BackupServiceTests.cs exists with 15+ test methods. Verify LogRetentionServiceTests.cs exists with 5+ test methods. Verify XEditLogFileServiceTests.cs exists with 7+ test methods.
  </verify>
  <done>
BackupService has comprehensive tests covering backup, restore, session management, and cleanup. LogRetentionService has tests for age-based and count-based retention with active file protection. XEditLogFileService has tests for path computation, staleness detection, and file reading. TEST-06 requirement for 80% critical path coverage on new features is satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: .NET framework verification, dependency updates, Code_To_Port removal, and CLAUDE.md cleanup</name>
  <files>
    AutoQAC/AutoQAC.csproj
    CLAUDE.md
  </files>
  <action>
**Step 1: Verify .NET target framework (per CONTEXT.md decision)**

Per user decision: "Bump target framework to latest stable .NET if available (e.g., .NET 10) -- verify Avalonia/ReactiveUI support first."

Verify the current target framework in AutoQAC/AutoQAC.csproj. The project is already on `net10.0-windows10.0.19041.0` (.NET 10). Confirm this is the latest stable .NET version available. Verify Avalonia 11.3.x and ReactiveUI 11.3.x support .NET 10 by checking that `dotnet build` succeeds without framework-related warnings.

Document in the summary: ".NET target framework verified as net10.0 (latest stable). Avalonia 11.3.11 and ReactiveUI.Avalonia 11.3.8 confirmed compatible -- project builds without framework warnings."

If .NET 10 is NOT the latest stable (e.g., if .NET 11 has been released), investigate upgrading and verify Avalonia/ReactiveUI support before bumping.

**Step 2: Update Mutagen packages (DEP-01)**

Update all three Mutagen packages in AutoQAC/AutoQAC.csproj from 0.52.0 to latest stable (currently 0.53.1):
```xml
<PackageReference Include="Mutagen.Bethesda" Version="0.53.1" />
<PackageReference Include="Mutagen.Bethesda.Skyrim" Version="0.53.1" />
<PackageReference Include="Mutagen.Bethesda.Fallout4" Version="0.53.1" />
```

After updating, run `dotnet build` to check for breaking API changes. If any breaking changes exist:
- Fix them immediately (per user decision: "fix the code to use the new API, don't leave deprecated patterns")
- The most likely change is Mutagen.Bethesda.Kernel moving from 0.52 to 0.53 -- check for any renamed types, changed method signatures, or removed APIs
- Look at the files that import Mutagen namespaces (likely PluginLoadingService or GameDetectionService) and verify they still compile

Then run `dotnet test AutoQAC.Tests` to verify no regressions.

**Step 3: Check all other packages for updates (DEP-02)**

Run `dotnet list package --outdated` for BOTH projects to identify any remaining outdated packages. The research indicated most packages are current, but verify. If any have updates:
- Update them in the relevant .csproj
- Fix any breaking API changes
- xUnit MUST stay at v2 (Avalonia.Headless.XUnit dependency per locked decision)

**Step 4: Remove Code_To_Port/ directory (POST-01)**

The research confirmed full feature parity plus enhancements. The CONTEXT.md user decision says: "Nothing to preserve from Code_To_Port/ -- git history is sufficient."

Run: `git rm -r Code_To_Port/`

This removes the directory from git tracking. The directory contains Python/Qt reference implementation files.

**Step 5: Clean CLAUDE.md**

Read CLAUDE.md fully. Remove ALL of the following (per user decision: "Full CLAUDE.md cleanup"):

1. The paragraph in "Project Overview" about Code_To_Port/ being temporary reference implementations
2. The entire "Reference Implementation Porting Guidelines" section (lines ~221-258) including:
   - "Study the Reference First" instructions
   - "Translate Concepts, Not Code" guidelines
   - The Python/Qt to C#/Avalonia translation table
   - "State Management" translation notes
3. Remove from "Development Workflow" section:
   - Step 1 "Reference Implementation" bullet
4. Remove from "Notes for Claude Code" section:
   - "Always reference the implementations in Code_To_Port/" bullet
   - "The Code_To_Port/ directory is temporary and will be removed at feature parity" bullet
   - "Ask for clarification if reference implementation behavior is unclear" bullet

Keep all other content intact. The CLAUDE.md should read as if Code_To_Port/ never existed -- it's a standalone C# project now.

**Step 6: Verify everything builds and passes**

Run `dotnet build` then `dotnet test AutoQAC.Tests` to confirm:
- No build errors from dependency updates
- No test failures from any change
- Code_To_Port/ is gone from working tree
- .NET framework is confirmed as net10.0
  </action>
  <verify>
1. `dotnet build AutoQAC` succeeds with 0 errors
2. `dotnet test AutoQAC.Tests` passes with 0 failures
3. `git status` shows Code_To_Port/ deleted
4. `dotnet list package --outdated` shows no outdated packages (or only xUnit v3 which we intentionally skip)
5. CLAUDE.md contains no references to "Code_To_Port", "porting", "reference implementation", or the translation table
6. AutoQAC.csproj TargetFramework is net10.0 (or later if available)
  </verify>
  <done>
.NET target framework verified as net10.0 (latest stable) with Avalonia/ReactiveUI compatibility confirmed. Mutagen packages updated to 0.53.1 with any breaking changes fixed. All NuGet packages are at latest compatible versions. Code_To_Port/ directory removed from repository. CLAUDE.md cleaned of all porting references and translation tables. Project builds and all tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build AutoQAC` succeeds with 0 errors
2. `dotnet test AutoQAC.Tests` passes with 0 failures and produces coverage output
3. Three new test files exist: BackupServiceTests.cs, LogRetentionServiceTests.cs, XEditLogFileServiceTests.cs
4. `dotnet list package --outdated` shows no actionable updates
5. Code_To_Port/ directory does not exist in working tree
6. CLAUDE.md contains zero references to Code_To_Port or porting guidelines
7. Total test count is at least 45 higher than the starting ~475
8. AutoQAC.csproj TargetFramework confirmed as net10.0 (latest stable .NET)
</verification>

<success_criteria>
- BackupService has 15+ test cases covering all public methods and failure paths (TEST-06)
- LogRetentionService has 5+ test cases covering both retention modes and edge cases (TEST-06)
- XEditLogFileService has 7+ test cases covering path computation, staleness, and reading (TEST-06)
- .NET target framework verified as net10.0 with Avalonia/ReactiveUI support confirmed (CONTEXT.md decision)
- Mutagen updated to 0.53.1 with no regressions (DEP-01)
- All packages at latest compatible versions (DEP-02)
- Code_To_Port/ removed and CLAUDE.md cleaned (POST-01)
- All tests pass, project builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/07-hardening-cleanup/07-02-SUMMARY.md`
</output>
